{% extends "base.html" %}
{% block content %}
<div class="mx-auto">
    <h2 class="text-xl font-bold mb-4">Expiry Tracker</h2>
    <form method="POST" class="mb-4 grid grid-cols-1 md:grid-cols-12 gap-2 items-end">
        <input type="text" name="name" class="md:col-span-5 w-full p-2 border rounded" placeholder="Item name..." required>
        <input type="date" name="expiry_date" class="md:col-span-4 w-full p-2 border rounded" required>
        <input type="hidden" name="creator" id="creator">
        <button type="submit" class="md:col-span-3 btn btn-primary">Add Item</button>
    </form>
    <ul>
        {% for item, days_left in items %}
        <li class="card p-4 mb-2 flex flex-wrap gap-2 items-center">
            <span class="flex-1">{{ item.name }}</span>
            {% set badge = 'bg-gray-100 text-gray-700 border-gray-300' %}
            {% if days_left is not none %}
                {% if days_left < 0 %}
                    {% set badge = 'bg-red-600 text-white border-red-700' %}
                {% elif days_left <= 7 %}
                    {% set badge = 'bg-red-100 text-red-700 border-red-300' %}
                {% elif days_left <= 15 %}
                    {% set badge = 'bg-amber-100 text-amber-700 border-amber-300' %}
                {% elif days_left >= 30 %}
                    {% set badge = 'bg-green-100 text-green-700 border-green-300' %}
                {% endif %}
            {% endif %}
            <span class="inline-flex items-center px-2 py-1 rounded border {{ badge }}" title="{{ days_left if days_left is not none else '' }} days left">
                {{ item.expiry_date.strftime('%Y-%m-%d') }}
                {% if days_left is not none %}
                    <span class="ml-2 text-xs">({{ 'Expired' if days_left < 0 else days_left ~ ' days left' }})</span>
                {% endif %}
            </span>
            <div class="text-xs text-gray-500">By {{ item.creator }} at {{ item.timestamp.strftime('%Y-%m-%d %H:%M') }}</div>
            <form method="POST" action="/expiry/delete/{{ item.id }}" class="delete-form" data-creator="{{ item.creator }}">
                <input type="hidden" name="user">
                <button type="submit" class="btn btn-danger">Delete</button>
            </form>
        </li>
        {% endfor %}
    </ul>
</div>
<script>
document.getElementById('creator').value = localStorage.getItem('username');
document.querySelectorAll('input[name="user"]').forEach(i=> i.value = localStorage.getItem('username'));
// Hide delete for non-owners
(function(){
    const adminName='{{ config.admin_name }}';
    const current=localStorage.getItem('username');
    document.querySelectorAll('.delete-form').forEach(f=>{
        const c=f.getAttribute('data-creator');
        if(!(current===c||current===adminName||current==='Administrator'||current==='admin')) f.style.display='none';
    });
})();
</script>
{% endblock %}
