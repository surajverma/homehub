{% extends "base.html" %}
{% block extra_head %}
<!-- Category color styles will be injected by script after DOM ready -->
<script>
window.REMINDERS_TIME_FORMAT = "{{ (config.reminders.time_format if config.reminders and config.reminders.time_format) or '12h' }}";
// Calendar start day injected from config (defaults to Sunday if invalid)
window.REMINDERS_CAL_START = (function(){
	var raw = "{{ (config.reminders.calendar_start_day if config.reminders and config.reminders.calendar_start_day is defined else 'sunday') }}";
	var val = (raw || '').trim().toLowerCase();
	var names = ['sunday','monday','tuesday','wednesday','thursday','friday','saturday'];
	if(/^\d$/.test(val)) { var num=parseInt(val,10); if(num>=0 && num<=6) return names[num]; }
	if(names.indexOf(val) !== -1) return val;
	return 'sunday';
})();
</script>
{% endblock %}
{% block content %}
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
	<div class="lg:col-span-2 space-y-6">
		<script id="familyMembersData" type="application/json">{{ config.family_members|tojson }}</script>
		<div class="card p-6">
			<h1 class="text-3xl font-bold mb-2"><i class="fa-solid fa-house text-blue-600 mr-2"></i>Welcome to {{ config.instance_name }}!</h1>
			<p class="mb-4 text-gray-600">Pick a tool from the left to get started.</p>
			<div class="text-sm text-gray-500" id="today"></div>
		</div>

			<div class="card p-6">
				<h2 class="text-xl font-bold mb-3"><i class="fa-solid fa-bullhorn text-amber-600 mr-2"></i>Family Notice Board</h2>
			{% if notice and notice.content %}
				<div class="prose max-w-none whitespace-pre-wrap bg-yellow-50 border border-yellow-200 rounded p-4">{{ notice.content }}</div>
				<div class="text-xs text-gray-500 mt-2">Last updated by {{ notice.updated_by }} at {{ notice.updated_at.strftime('%Y-%m-%d %H:%M') }}</div>
			{% else %}
				<div class="text-gray-500">No notices yet. Admin can post one below.</div>
			{% endif %}
			<form method="POST" action="/notice" class="mt-4 space-y-2" id="noticeForm">
				<textarea name="content" rows="4" class="w-full p-2 border rounded" placeholder="Leave blank and submit to clear the notice"></textarea>
				<input type="hidden" name="user" value="">
				<button type="submit" class="btn btn-primary">Update Notice (Admin)</button>
			</form>
		</div> <!-- /card -->

		<!-- Two-column (Who is Home + Personal Status) under Notice Board -->
		{% set show_who = config.feature_toggles.who_is_home %}
		{% set show_status = (config.feature_toggles.personal_status if config.feature_toggles.personal_status is defined else True) %}
		{% set two_col = show_who and show_status %}
		<div class="grid {{ 'md:grid-cols-2' if two_col else 'md:grid-cols-1' }} gap-6">
			<!-- Who is Home (compact) -->
			{% if show_who %}
			<div class="card p-4" id="whoHomeCard">
				<h2 class="text-lg font-semibold mb-3 flex items-center gap-2"><i class="fa-solid fa-house-user text-green-600"></i> Who is Home?</h2>
				<div id="whoStatusList" class="flex flex-wrap gap-2 mb-3 text-xs">
					{% for member in config.family_members %}
						{% set st = who_statuses.get(member) %}
						<span class="px-2 py-1 rounded border bg-white flex items-center gap-1" data-member="{{ member }}">
							<span class="font-medium">{{ member }}</span>
							<span class="status-pill px-1.5 py-0.5 rounded text-[10px] leading-none
							{% if st == 'Home' %} bg-green-100 text-green-700 border border-green-300
							{% elif st == 'Away' %} bg-gray-100 text-gray-600 border border-gray-300
							{% elif st == 'Out' %} bg-amber-100 text-amber-700 border border-amber-300
							{% elif st == 'Traveling' %} bg-indigo-100 text-indigo-700 border border-indigo-300
							{% elif st %} bg-blue-100 text-blue-700 border border-blue-300
							{% else %} bg-gray-100 text-gray-500 border border-gray-200
							{% endif %}">{{ st or '—' }}</span>
						</span>
					{% endfor %}
				</div>
				<form id="whoUnifiedForm" method="POST" action="/whoishome" onsubmit="return false" class="flex flex-wrap items-center gap-2 text-xs" data-ajax="1">
					<input type="hidden" name="action" id="whoAction" value="update">
					<input type="hidden" name="name" id="whoName" value="">
					<select name="status" class="border rounded p-1 text-xs">
						<option>Home</option>
						<option>Away</option>
						<option>Out</option>
						<option>Traveling</option>
					</select>
					<button id="whoUpdateBtn" type="submit" class="px-2 py-1 rounded bg-blue-600 text-white hover:bg-blue-700">Update</button>
					<button id="whoClearBtn" type="button" class="px-2 py-1 rounded border bg-white hover:bg-gray-50" title="Clear my status">Clear</button>
				</form>
            </div>
			{% endif %}

			<!-- Personal Status (compact) -->
			{% if show_status %}
			<div class="card p-4" id="personalStatusCard">
				<h3 class="text-lg font-semibold mb-3 flex items-center gap-2"><i class="fa-solid fa-user-pen text-blue-600"></i> Personal Status</h3>
				<div id="memberStatusChips" class="flex flex-wrap gap-2 mb-3 text-xs">
					{% for name, text in member_statuses.items() %}
						<span data-name="{{ name }}" class="px-2 py-1 rounded border bg-white shadow-sm">{{ text }} <span class="text-gray-500 text-[10px]">— {{ name }}</span></span>
					{% endfor %}
				</div>
				<form id="memberStatusForm" action="/status/update" method="POST" class="flex items-center gap-2 text-xs">
					<input type="hidden" name="name" id="memberStatusName" value="">
					<input type="text" name="text" placeholder="My status" class="flex-1 border rounded p-1" />
					<button type="submit" class="px-2 py-3 rounded bg-blue-600 text-white hover:bg-blue-700">Save</button>
				</form>
				<form id="memberStatusDelete" action="/status/delete" method="POST" class="mt-2 text-right">
					<input type="hidden" name="name" id="memberStatusDeleteName" value="">
					<button type="submit" class="px-2 py-1 rounded bg-red-600 text-white hover:bg-red-700 text-xs">Remove My Status</button>
				</form>
			</div>
			{% endif %}
		</div>
	</div><!-- /left col -->

	<div class="space-y-6">
		<!-- Reminders & Calendar (moved to right column) -->
		<div class="card p-6" id="remindersCard" style="min-height:520px">
			<h2 class="text-xl font-bold flex items-center gap-2 mb-3"><i class="fa-solid fa-calendar-days text-blue-600"></i> Reminders</h2>
			<div id="reminderMonthNav" class="flex items-center justify-between mb-2">
				<button type="button" id="calPrev" class="px-2 py-1 rounded border bg-white hover:bg-gray-50" aria-label="Previous Month">◀</button>
				<div id="calLabel" class="font-semibold flex-1 text-center"></div>
				<button type="button" id="calNext" class="px-2 py-1 rounded border bg-white hover:bg-gray-50" aria-label="Next Month">▶</button>
			</div>
			<div class="flex justify-end mb-2"><button id="backToToday" type="button" class="hidden text-xs text-blue-600 hover:underline">Back to Today</button></div>
			<div id="reminderWeekdayRow" class="grid grid-cols-7 gap-1 text-xs font-semibold text-gray-600 mb-1"></div>
			<div id="calendar" class="grid grid-cols-7 gap-1 mb-4"></div>
			<div class="flex items-center flex-wrap gap-2 mb-2" id="remindersHeader">
				<button type="button" id="openAdd" class="btn btn-primary text-sm">Add Reminder</button>
				<div class="text-sm text-gray-600" id="remindersSelectedDate"></div>
				<div class="flex items-center gap-2 ml-auto" id="scopeBarWrap"></div>
			</div>
			<!-- Inline form now appears directly under header -->
			<div id="reminderInlineFormWrap" class="hidden mb-3">
				<form id="reminderInlineForm" class="space-y-3 bg-gray-50 dark:bg-slate-800/60 border rounded p-3">
					<input type="hidden" name="id" value="">
					<div>
						<label class="block text-xs font-semibold mb-1">Title</label>
						<input type="text" name="title" required class="w-full h-10 border rounded p-2 text-sm" placeholder="Reminder title">
					</div>
					<div class="grid grid-cols-1 md:grid-cols-2 gap-3">
						<div>
							<label class="block text-xs font-semibold mb-1">Date</label>
							<input name="date" required type="date" class="h-10 w-full border rounded p-2 text-sm">
						</div>
						<div>
							<label class="block text-xs font-semibold mb-1">Time</label>
							<input name="time" type="time" class="h-10 w-full border rounded p-2 text-sm" aria-label="Reminder time (optional)">
						</div>
					</div>
					<div id="categorySelectRow" class="hidden">
						<div class="flex items-end justify-between gap-3">
							<div class="flex-1">
								<label class="block text-xs font-semibold mb-1">Category</label>
								<select name="category" class="h-10 w-full border rounded p-2 text-sm"></select>
							</div>
							<label class="inline-flex items-center gap-2 text-xs flex-shrink-0 mb-1">
								<input type="checkbox" name="is_recurring" class="rounded">
								<span>Recurring</span>
							</label>
						</div>
					</div>
					<!-- Recurrence controls: hidden until Recurring is checked -->
					<div id="recurrenceControls" class="hidden space-y-2">
						<div class="grid grid-cols-1 md:grid-cols-3 gap-3 items-end">
							<label class="text-xs text-gray-700 self-center">Repeat this every</label>
							<input name="rec_interval" type="number" min="1" step="1" value="1" class="h-10 w-full border rounded p-2 text-sm" aria-label="Recurrence interval">
							<select name="rec_unit" class="h-10 w-full border rounded p-2 text-sm" aria-label="Recurrence unit">
								<option value="day">day</option>
								<option value="week">week</option>
								<option value="month">month</option>
								<option value="year">year</option>
							</select>
						</div>
						<div class="grid grid-cols-1 md:grid-cols-2 gap-3 items-end">
							<label class="text-xs text-gray-700 self-center">till</label>
							<input name="rec_end_date" type="date" class="h-10 w-full border rounded p-2 text-sm" placeholder="End date (optional)" aria-label="End date (optional)">
						</div>
					</div>
					<div>
						<label class="block text-xs font-semibold mb-1">Description</label>
						<textarea name="description" rows="2" class="w-full border rounded p-2 text-sm"></textarea>
					</div>
					<div class="flex gap-2 justify-end pt-2 border-t">
						<button type="button" id="reminderCancelBtn" class="px-3 py-1.5 text-sm rounded border bg-white dark:bg-slate-700 hover:bg-gray-50 dark:hover:bg-slate-600">Cancel</button>
						<button type="submit" id="reminderSaveBtn" class="px-3 py-1.5 text-sm rounded bg-blue-600 text-white hover:bg-blue-700">Save</button>
					</div>
				</form>
			</div>
			<form id="bulkDeleteForm" class="mb-2" data-creator="" >
				<div id="remindersBulkBar" class="hidden flex items-center gap-3 bg-red-50 border border-red-200 rounded p-2 text-xs">
					<span><span id="bulkCount">0</span> selected</span>
					<input type="hidden" id="bulkIds" value="">
					<input type="hidden" id="bulkUser" name="creator" value="">
					<button type="submit" class="px-2 py-1 rounded bg-red-600 text-white hover:bg-red-700">Delete Selected</button>
					<button type="button" id="bulkClearSel" class="px-2 py-1 rounded border bg-white hover:bg-gray-50">Clear</button>
				</div>
			</form>
			<div class="flex items-center justify-between mb-1 text-[11px] text-gray-500">
				<div id="reminderCategorySummary" class="flex flex-wrap gap-2"></div>
			</div>
			<div id="remindersScroll" class="space-y-2 max-h-72 overflow-auto border rounded p-2 bg-white" aria-label="Reminders list"></div>
			<noscript>
				<div class="mt-4 text-sm text-gray-600">JavaScript disabled: reminders editing requires JS. Existing reminder counts are shown on the calendar only.</div>
			</noscript>
		</div>


		<script id="legacyRemindersData" type="application/json">{% if reminders_data is defined %}{{ reminders_data|tojson }}{% else %}{{ reminders_json|safe }}{% endif %}</script>
		<script id="reminderCategoriesData" type="application/json">{{ reminder_categories|tojson }}</script>
		<script>
// Inject category color classes immediately after data is available
(function(){
	try {
		var dataEl = document.getElementById('reminderCategoriesData');
		const cats = JSON.parse(dataEl ? dataEl.textContent || '[]' : '[]');
		let css = '';
		cats.forEach(c=>{ 
			if(!c || !c.key) return; 
			const key=(c.key+'').replace(/[^a-zA-Z0-9_-]/g,''); 
			const col=c.color||'#6b7280'; 
			css += '.rem-cat-dot-'+key+'{background:'+col+' !important;}'; 
		});
		css += '.rem-cat-pill{transition:background-color .15s,box-shadow .15s;}';
		css += '.rem-cat-pill:hover{box-shadow:0 0 0 1px rgba(var(--primary-rgb,37,99,235),0.35);}';
		const el=document.createElement('style'); 
		el.id='reminder-category-styles'; 
		el.textContent=css; 
		document.head.appendChild(el);
	}catch(e){ console.warn('Category style inject failed', e); }
})();
</script>
		<script>
// --- Reminders Progressive Enhancement (clean re-integration) ---
(function(){
	// Wait until remindersApi is available (in case script ordering delays)
	if(!window.remindersApi){
		let tries=0; const timer=setInterval(()=>{
			if(window.remindersApi){ clearInterval(timer); init(); }
			else if(++tries>20){ clearInterval(timer); }
		},150);
		return;
	}
	init();
	function init(){
	const cal = document.getElementById('calendar');
	const calLabel = document.getElementById('calLabel');
	const prevBtn = document.getElementById('calPrev');
	const nextBtn = document.getElementById('calNext');
	const header = document.getElementById('remindersHeader');
	const listWrap = document.getElementById('remindersScroll');
	const bulkBar = document.getElementById('remindersBulkBar');
	const bulkCount = document.getElementById('bulkCount');
	const bulkIds = document.getElementById('bulkIds');
	const bulkUser = document.getElementById('bulkUser');
	const inlineWrap = document.getElementById('reminderInlineFormWrap');
	const inlineForm = document.getElementById('reminderInlineForm');
	const categoryRow = document.getElementById('categorySelectRow');
	const scopeBarWrap = document.getElementById('scopeBarWrap');
	const categorySelect = categoryRow.querySelector('select');
	const categoryFilter = null; // dropdown removed; using pills only
	const cancelBtn = document.getElementById('reminderCancelBtn');
	const selectedDateDisplay = document.getElementById('remindersSelectedDate');
	let editingId = null;
	let currentScope = localStorage.getItem('remindersScope') || 'day';
	let display = new Date(); // current month
	let monthCache = {}; // YYYY-MM -> { reminders:[], counts:{}, categories_counts:{} }
	const legacyDataEl = document.getElementById('legacyRemindersData');
	const catDataEl = document.getElementById('reminderCategoriesData');
	let live = document.getElementById('reminderLiveRegion');
	if(!live){ live=document.createElement('div'); live.id='reminderLiveRegion'; live.className='sr-only'; live.setAttribute('aria-live','polite'); header.appendChild(live);}  
	// Use global toast from base.html (no duplicate toast host)
	function toast(msg,type='info'){
		if(window.globalToast){ window.globalToast(msg,type); }
		if(live) live.textContent=msg;
	}
	let catPalette={};
	try{ const cats=JSON.parse(catDataEl?.textContent||'[]'); if(cats.length){ categoryRow.classList.remove('hidden'); categorySelect.innerHTML='<option value="">(No category)</option>'+cats.map(c=>`<option value="${c.key}">${c.label||c.key}</option>`).join(''); cats.forEach(c=>{ catPalette[c.key]=c.color||'#2563eb'; }); } }catch(e){}
	function categoryColor(k){ return catPalette[k]; }
	function escapeHtml(str){ return (str||'').replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }
	// Unified bulk bar updater (delegated-safe)
	function updateBulkUI(){
		const checked = Array.from(listWrap.querySelectorAll('.reminderChk:checked'));
		bulkCount.textContent = String(checked.length);
		bulkIds.value = checked.map(cb=>cb.value).join(',');
		bulkBar.classList.toggle('hidden', checked.length===0);
	}
	// One-time delegated listeners for checkbox changes and single-delete
	if(!listWrap.dataset.delegated){
		listWrap.dataset.delegated = '1';
		listWrap.addEventListener('change', (e)=>{
			if(e.target && e.target.matches && e.target.matches('.reminderChk')){
				updateBulkUI();
			}
		});
		listWrap.addEventListener('click', (e)=>{
			const delBtn = e.target && e.target.closest ? e.target.closest('.deleteOne') : null;
			if(delBtn){
				const row = delBtn.closest('[data-reminder-row]');
				if(!row) return;
				const id = parseInt(row.getAttribute('data-id'));
				const dateStr = row.getAttribute('data-date')||'';
				if(!id) return;
				const creator = localStorage.getItem('username')||'';
				window.remindersApi.removeMany([id], creator).then(resp=>{
					if(resp && resp.ok){
						Object.values(monthCache).forEach(mc=>{ mc.reminders = (mc.reminders||[]).filter(x=>x.id!==id); });
						// If this id was selected, uncheck and update bulk bar
						const selCb = listWrap.querySelector(`.reminderChk[value="${id}"]`);
						if(selCb){ selCb.checked = false; }
						toast('Deleted','success');
						renderList();
						updateBulkUI();
						updateCalendarBadges();
					}else{
						toast('Delete failed','error');
					}
				});
			}
		});
		const bulkForm = document.getElementById('bulkDeleteForm');
		const clearBtn = document.getElementById('bulkClearSel');
		if(clearBtn){
			clearBtn.addEventListener('click', ()=>{
				listWrap.querySelectorAll('.reminderChk').forEach(c=>{ c.checked=false; });
				updateBulkUI();
			});
		}
		if(bulkForm && !bulkForm._delegated){
			bulkForm._delegated = true;
			bulkForm.addEventListener('submit', (e)=>{
				e.preventDefault();
				const checked = Array.from(listWrap.querySelectorAll('.reminderChk:checked'));
				if(!checked.length){ return; }
				const ids = checked.map(cb=>parseInt(cb.value));
				const creator = localStorage.getItem('username')||'';
				window.remindersApi.removeMany(ids, creator).then(resp=>{
					if(!resp || !resp.ok){ toast('Delete failed','error'); return; }
					Object.values(monthCache).forEach(mc=>{ mc.reminders = (mc.reminders||[]).filter(r=>!ids.includes(r.id)); });
					toast('Deleted '+ids.length,'success');
					// Clear any selections and hide the bulk bar
					listWrap.querySelectorAll('.reminderChk').forEach(c=>{ c.checked=false; });
					updateBulkUI();
					renderList();
					updateCalendarBadges();
				});
			});
		}
	}
	function setSelectedDate(d){ header.setAttribute('data-selected-date', d); selectedDateDisplay.textContent=d; localStorage.setItem('remindersSelectedDate', d); }
	function getSelectedDate(){ return header.getAttribute('data-selected-date') || localStorage.getItem('remindersSelectedDate') || new Date().toISOString().slice(0,10); }
	const scopeBar=document.createElement('div'); scopeBar.className='flex gap-1'; scopeBar.innerHTML=['day','week','month'].map(s=>`<button type="button" data-scope="${s}" class="px-2 py-0.5 text-xs rounded border scopeBtn ${s===currentScope?'border-blue-500 text-blue-600 bg-blue-50':'border-gray-300 bg-white text-gray-600 hover:bg-gray-100'}">${s[0].toUpperCase()+s.slice(1)}</button>`).join(''); scopeBarWrap.appendChild(scopeBar);
	scopeBar.addEventListener('click', e=>{ const b=e.target.closest('button[data-scope]'); if(!b)return; currentScope=b.getAttribute('data-scope'); localStorage.setItem('remindersScope', currentScope); scopeBar.querySelectorAll('.scopeBtn').forEach(btn=>{ const act=btn.getAttribute('data-scope')===currentScope; btn.className='px-2 py-0.5 text-xs rounded border scopeBtn '+(act?'border-blue-500 text-blue-600 bg-blue-50':'border-gray-300 bg-white text-gray-600 hover:bg-gray-100'); }); renderList(); });
	function openForm(mode,dateStr,data){ inlineForm.reset(); editingId=null; inlineForm.querySelector('[name=id]').value=''; inlineForm.querySelector('[name=date]').value=dateStr; if(mode==='edit'&&data){ editingId=data.id; inlineForm.querySelector('[name=id]').value=data.id; inlineForm.querySelector('[name=title]').value=data.title; inlineForm.querySelector('[name=description]').value=data.description||''; if(data.category && categorySelect) categorySelect.value=data.category; if(data.time) inlineForm.querySelector('[name=time]').value=data.time; }
		// reset recurring toggle state each time the form opens
		if(recChk){ recChk.checked = false; }
		toggleRecurringFields();
		inlineWrap.classList.remove('hidden'); setTimeout(()=>inlineForm.querySelector('[name=title]').focus(),30); }
	function closeForm(){ inlineWrap.classList.add('hidden'); editingId=null; if(typeof window.__editingRuleId!== 'undefined'){ window.__editingRuleId=null; } if(inlineForm){ inlineForm.reset(); } if(recChk){ recChk.checked=false; } toggleRecurringFields(); }
	cancelBtn.addEventListener('click', closeForm);
	document.getElementById('openAdd').addEventListener('click', ()=> openForm('create', getSelectedDate(), null));
	// Recurring controls (enable/disable dependent fields)
	const recChk = inlineForm ? inlineForm.querySelector('[name=is_recurring]') : null;
	const recControls = document.getElementById('recurrenceControls');
	function toggleRecurringFields(){
		const on = !!(recChk && recChk.checked);
		if(recControls){ recControls.classList.toggle('hidden', !on); }
		['rec_interval','rec_unit','rec_end_date'].forEach(n=>{
			const el = inlineForm ? inlineForm.querySelector(`[name=${n}]`) : null;
			if(el){ el.disabled = !on; }
		});
	}
	if(recChk){ recChk.addEventListener('change', toggleRecurringFields); toggleRecurringFields(); }

	// Recalculate counts & category aggregates for a month key (YYYY-M), including recurring rule dates
	function recalcMonth(key){
		const bucket = monthCache[key];
		if(!bucket) return;
		const counts = {};
		const catsCounts = {};
		const reminders = bucket.reminders || [];
		// Count actual reminders first
		reminders.forEach(r => {
			const k = r.date;
			counts[k] = (counts[k] || 0) + 1;
			const c = r.category || '_uncategorized';
			if(!catsCounts[k]) catsCounts[k] = {};
			catsCounts[k][c] = (catsCounts[k][c] || 0) + 1;
		});
		// For recurring rules, only add dates that are NOT already represented by a reminder for that rule/date
		(bucket.recurring_rules || []).forEach(rr => {
			const c = rr.category || '_uncategorized';
			(rr.dates || []).forEach(dstr => {
				const exists = reminders.some(r => (r.recurring_id == rr.id || String(r.recurring_id) === String(rr.id)) && r.date === dstr);
				if(!exists){
					counts[dstr] = (counts[dstr] || 0) + 1;
					if(!catsCounts[dstr]) catsCounts[dstr] = {};
					catsCounts[dstr][c] = (catsCounts[dstr][c] || 0) + 1;
				}
			});
		});
		bucket.counts = counts;
		bucket.categories_counts = catsCounts;
	}

	inlineForm.addEventListener('submit', async e=>{
		e.preventDefault();
		const fd=new FormData(inlineForm);
		const data=Object.fromEntries(fd.entries());
		const creator=localStorage.getItem('username')||'';
		const payload={title:data.title, date:data.date, time:data.time||undefined, description:data.description, creator: creator, category:data.category||undefined};
		// include recurring payload when checkbox checked (interval+unit)
		if(recChk && recChk.checked){
			let interval = parseInt(data.rec_interval, 10);
			if(!Number.isFinite(interval) || interval < 1){ interval = 1; }
			const unit = (data.rec_unit||'day');
			payload.recurring = {
				interval,
				unit,
				end_date: data.rec_end_date || undefined
			};
		}
		// If editing a recurring rule, call rule PATCH instead of reminder create/update
		let res; const touchedMonths=new Set();
		if(window.__editingRuleId){
			const rid = window.__editingRuleId; const rulePayload = { creator: creator, title: data.title, description: data.description, time: data.time||undefined, category: data.category||undefined };
			if(data.date) rulePayload.start_date = data.date;
			// If user unchecked recurring for a rule, convert rule -> single reminder
			if(recChk && !recChk.checked){
				// Create a single reminder using the current form date
				const createSingle = await window.remindersApi.create({ title: data.title, date: data.date, time: data.time||undefined, description: data.description, creator: creator, category: data.category||undefined });
				if(createSingle && createSingle.ok){
					// Delete the recurring rule
					const del = await window.remindersApi.deleteRule(rid, creator);
					if(del && del.ok){
						res = { ok: true, converted: 'rule-to-single', reminder: createSingle.reminder };
					}else{
						res = { ok: false, error: (del && del.error) || 'Failed to delete rule after creating single' };
					}
				}else{
					res = { ok: false, error: (createSingle && createSingle.error) || 'Failed to create single reminder' };
				}
			}
			else {
				// Regular rule update path
				if(recChk && recChk.checked){ let interval=parseInt(data.rec_interval,10); if(!Number.isFinite(interval)||interval<1) interval=1; rulePayload.interval=interval; rulePayload.unit=(data.rec_unit||'day'); rulePayload.end_date=(data.rec_end_date||undefined); }
				res = await window.remindersApi.updateRule(rid, rulePayload);
			}
			if(res && res.ok){
				// Refresh the displayed month so calendar badges update correctly
				const dispKey = display.getFullYear()+'-'+String(display.getMonth()+1).padStart(2,'0');
				await fetchMonth(dispKey+'-01', true);
				touchedMonths.add(dispKey);
				// Also refresh the form date's month if different (rule anchor changed)
				if(data.date){ const d=new Date(data.date); const key=d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0'); if(key!==dispKey){ await fetchMonth(key+'-01', true); touchedMonths.add(key); } }
			}
		}
		else if(data.id){ // update existing single reminder
			const id=parseInt(data.id);
			// If user checked recurring on a single reminder, convert single -> recurring rule
			if(recChk && recChk.checked && payload.recurring){
				const makeRule = await window.remindersApi.create(payload);
				if(makeRule && makeRule.ok){
					// Remove the original single reminder
					const del = await window.remindersApi.removeMany([id], creator);
					if(del && del.ok){
						res = { ok: true, converted: 'single-to-rule', recurring_id: makeRule.recurring_id };
						// Update local caches: remove old single, refresh month(s) for new rule
						let origMonthKey = null;
						Object.entries(monthCache).forEach(([k,mc])=>{
							const before = (mc.reminders||[]).length;
							mc.reminders = (mc.reminders||[]).filter(r=>r.id!==id);
							if(before !== (mc.reminders||[]).length){ origMonthKey = k; }
						});
						// Fetch the month for the selected/form date to pick up the new rule
						if(data.date){
							await fetchMonth(data.date, true);
						}
						// Also refresh current display month if different
						const dispKey = display.getFullYear()+'-'+String(display.getMonth()+1).padStart(2,'0');
						const formKey = (function(){ const d=new Date(data.date); return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0'); })();
						if(formKey !== dispKey){ await fetchMonth(dispKey+'-01', true); }
					}else{
						res = { ok: false, error: (del && del.error) || 'Failed to delete original reminder after creating recurring rule' };
					}
				}else{
					res = { ok: false, error: (makeRule && makeRule.error) || 'Failed to create recurring rule' };
				}
			} else {
				// Normal update of single reminder
				res=await window.remindersApi.update(id,payload);
				if(res.ok){ Object.entries(monthCache).forEach(([k,mc])=>{ const before=mc.reminders.length; mc.reminders=mc.reminders.filter(r=>r.id!==id); if(before!==mc.reminders.length) touchedMonths.add(k); }); if(res.reminder && res.reminder.date){ await fetchMonth(res.reminder.date, true); const d=new Date(res.reminder.date); const key=d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0'); touchedMonths.add(key); } }
			}
		} else { // create
			res=await window.remindersApi.create(payload);
			if(res.ok){
				if(res.reminder && res.reminder.date){
					await fetchMonth(res.reminder.date, true);
					const d=new Date(res.reminder.date); const key=d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0'); touchedMonths.add(key);
				} else if(res.recurring_id){
					// For recurring rules, just refresh the month of the selected date to synthesize occurrences
					await fetchMonth(data.date, true);
					const d=new Date(data.date); const key=d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0'); touchedMonths.add(key);
				}
			}
		}
		if(res && res.ok){ touchedMonths.forEach(k=>recalcMonth(k)); updateCalendarBadges(); closeForm(); renderList(); let msg='Saved'; if(window.__editingRuleId) msg='Recurring rule updated'; else if(data.id) msg='Reminder updated'; else if(res.recurring_id) msg='Recurring rule saved'; else msg='Reminder added'; toast(msg,'success'); } else { toast((res&&res.error)||'Save failed','error'); }
	});
	async function fetchMonth(dateStr, force=false){ const d=new Date(dateStr); const key=d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0'); if(monthCache[key] && !force) return monthCache[key]; let res; try{ res=await window.remindersApi.list('month', key+'-01'); if(res.ok) monthCache[key]=res; }catch(e){ toast('Network error','error'); } return monthCache[key]||{reminders:[],counts:{},categories_counts:{},recurring_rules:[]}; }
	function buildWeekdayHeader(){
		const row=document.getElementById('reminderWeekdayRow'); if(!row) return; const base=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
		// Convert config start day to index
		let startName = (window.REMINDERS_CAL_START||'sunday').toLowerCase();
		const idxMap = {sunday:0,monday:1,tuesday:2,wednesday:3,thursday:4,friday:5,saturday:6};
		let startIdx = idxMap[startName]; if(startIdx===undefined) startIdx=0;
		const ordered=[]; for(let i=0;i<7;i++){ ordered.push(base[(startIdx+i)%7]); }
		row.innerHTML=ordered.map(n=>'<div>'+n.slice(0,3)+'</div>').join('');
	}
	buildWeekdayHeader();
	function renderCalendar() {
	    const year = display.getFullYear();
	    const month = display.getMonth();
	    calLabel.textContent = display.toLocaleString(undefined, { month: 'long', year: 'numeric' });
	    cal.innerHTML = '';
	    const today = new Date();
	    const curKey = year + '-' + month;
	    const todayKey = today.getFullYear() + '-' + today.getMonth();
	    const selected = getSelectedDate();
	    const todayBtn = document.getElementById('backToToday');
	    if (todayBtn) {
	        todayBtn.classList.toggle('hidden', curKey === todayKey);
	        if (!todayBtn.dataset.bound) {
	            todayBtn.dataset.bound = '1';
	            todayBtn.addEventListener('click', () => {
	                const now = new Date();
	                display = new Date(now.getFullYear(), now.getMonth(), 1);
	                const todayStr = now.toISOString().slice(0, 10);
	                setSelectedDate(todayStr);
	                buildAndEnsure();
	                renderList();
	            });
	        }
	    }
	    const firstDay = new Date(year, month, 1);
	    // Compute offset based on configured week start
	    const weekStartName = (window.REMINDERS_CAL_START||'sunday').toLowerCase();
	    const nameToIdx = {sunday:0,monday:1,tuesday:2,wednesday:3,thursday:4,friday:5,saturday:6};
	    let startIdx = nameToIdx[weekStartName]; if(startIdx===undefined) startIdx=0;
	    // firstDay.getDay() returns 0=Sunday..6=Saturday; we want number of blanks before first day in custom week
	    let gap = firstDay.getDay() - startIdx; if(gap < 0) gap += 7;
	    for (let i = 0; i < gap; i++) {
	        const empty = document.createElement('div');
	        empty.className = 'calendar-day-empty';
	        cal.appendChild(empty);
	    }
	    const days = new Date(year, month + 1, 0).getDate();
	    for (let d = 1; d <= days; d++) {
	        const dateStr = year + '-' + String(month + 1).padStart(2, '0') + '-' + String(d).padStart(2, '0');
	        const btn = document.createElement('button');
	        btn.type = 'button';
	        const isToday = dateStr === today.toISOString().slice(0, 10);
	        const isSel = dateStr === selected;
	        btn.className = 'calendar-day relative p-2 rounded border text-left focus:outline-none focus:ring-2 focus:ring-blue-400 hover:bg-blue-50 dark:hover:bg-slate-700 ' +
	            (isSel ? 'bg-blue-50 dark:bg-slate-700 border-blue-500' : '');
	        btn.setAttribute('aria-pressed', isSel ? 'true' : 'false');
	        btn.innerHTML = '<div class="font-semibold ' + (isToday ? 'text-blue-600' : '') + '">' + d + '</div>';
	        const monthKey = year + '-' + String(month + 1).padStart(2, '0');
	        const cache = monthCache[monthKey] || {};
	        const count = (cache.counts || {})[dateStr];
	        if (count) {
	            const badge = document.createElement('span');
	            badge.className = 'day-count-badge absolute -top-1 -right-1 inline-flex items-center justify-center w-4 h-4 text-[9px] rounded-full bg-blue-600 text-white';
	            badge.textContent = count;
	            btn.appendChild(badge);
	            const cats = (cache.categories_counts || {})[dateStr];
	            if (cats) {
	                const wrap = document.createElement('div');
	                wrap.className = 'absolute left-1 bottom-1 flex gap-0.5 cat-dots';
	                Object.entries(cats).slice(0, 5).forEach(([k, _v]) => {
	                    if (k === '_uncategorized') return;
	                    const dot = document.createElement('span');
	                    dot.className = 'w-1.5 h-1.5 rounded-full rem-cat-dot-' + k;
	                    wrap.appendChild(dot);
	                });
	                btn.appendChild(wrap);
	            }
	        }
	        btn.addEventListener('click', () => {
	            setSelectedDate(dateStr);
	            renderList();
	            renderCalendar();
	        });
	        cal.appendChild(btn);
	    }
	}
	function updateCalendarBadges(){ // ensure counts are in sync for currently loaded months
	Object.keys(monthCache).forEach(recalcMonth); renderCalendar(); }
	// Extract mapping logic for legacy reminders
	function mapLegacyReminder(r, d) {
	    return {
	        id: r.id,
	        title: r.title,
	        description: r.description,
	        creator: r.creator,
	        date: d,
	        time: r.time || null,
	        category: r.category || null
	    };
	}
	try {
	    const legacy = JSON.parse(legacyDataEl?.textContent || '{}');
	    const today = new Date();
	    const mk = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0');
	    monthCache[mk] = { reminders: [], counts: {}, categories_counts: {} };
	    Object.entries(legacy).forEach(([d, arr]) => {
	        if (d.startsWith(mk + '-')) {
	            monthCache[mk].counts[d] = arr.length;
	            monthCache[mk].reminders.push(...arr.map(r => mapLegacyReminder(r, d)));
	        }
	    });
	    recalcMonth(mk);
	} catch (e) {}
	let activeCategory = 'ALL';
	function renderList(){ const dateStr=getSelectedDate(); const dObj=new Date(dateStr); const mkey=dObj.getFullYear()+'-'+String(dObj.getMonth()+1).padStart(2,'0'); const cache=monthCache[mkey]; if(!cache){ listWrap.innerHTML='<div class="text-xs text-gray-400">Loading...</div>'; fetchMonth(dateStr).then(()=>{ renderCalendar(); renderList(); }); return;} let baseItems=[]; // Unfiltered items for current scope
	// Filter baseItems to non-recurring generated occurrences (skip those with recurring_id)
	if(currentScope==='day'){ baseItems=cache.reminders.filter(r=>r.date===dateStr && !r.recurring_id);} else if(currentScope==='week'){ const base=dObj; const mon=new Date(base.getFullYear(), base.getMonth(), base.getDate()-((base.getDay()+6)%7)); const end=new Date(mon.getFullYear(), mon.getMonth(), mon.getDate()+6); baseItems=cache.reminders.filter(r=>{ const rd=new Date(r.date); return !r.recurring_id && rd>=mon && rd<=end; }); } else { baseItems=cache.reminders.filter(r=>!r.recurring_id); }
	// If activeCategory no longer present in this scope, reset to ALL
	const rulesCats = (cache.recurring_rules||[]).map(rr=>rr.category).filter(Boolean);
	if(activeCategory!=='ALL' && !baseItems.some(r=>r.category===activeCategory) && !rulesCats.includes(activeCategory)) activeCategory='ALL';

	function formatRepeat(n, unit, endDate){ const label = (n||1)===1? unit : unit+'s'; return 'Repeats every '+(n||1)+' '+label+(endDate? (' till '+endDate):''); }
	function fmtTime(val){ if(!val) return ''; if(window.REMINDERS_TIME_FORMAT==='24h') return val; const [h,m]=val.split(':'); let hh=parseInt(h,10); const ap=hh>=12?'PM':'AM'; hh = (hh%12)||12; return hh+':'+m+' '+ap; }

	// Build compressed list = recurring rules intersecting scope + singles
	const out=[];
	const addRule = (rr)=>{ out.push({isRule:true, id: rr.id, title: rr.title, description: rr.description, creator: rr.creator, time: rr.time, category: rr.category, interval: rr.interval, unit: rr.unit, end_date: rr.end_date}); };
	if(cache.recurring_rules && cache.recurring_rules.length){
		const within = (ds)=>{ if(currentScope==='day') return ds===dateStr; if(currentScope==='week'){ const base=dObj; const mon=new Date(base.getFullYear(), base.getMonth(), base.getDate()-((base.getDay()+6)%7)); const end=new Date(mon.getFullYear(), mon.getMonth(), mon.getDate()+6); const rd=new Date(ds); return rd>=mon && rd<=end; } return true; };
		for(const rr of cache.recurring_rules){ if(activeCategory!=='ALL' && rr.category!==activeCategory) continue; if((rr.dates||[]).some(within)) addRule(rr); }
	}
	const singles = (activeCategory==='ALL'? baseItems : baseItems.filter(r=> r.category===activeCategory));
	out.push(...singles);

	// Render compressed list
	listWrap.innerHTML=''; if(!out.length){ listWrap.innerHTML='<div class="text-gray-500">No reminders</div>'; updateBulkUI(); } else {
		out.sort((a,b)=>{ if(a.isRule && !b.isRule) return -1; if(!a.isRule && b.isRule) return 1; if(a.isRule && b.isRule) return (a.title||'').localeCompare(b.title||''); return (a.date||'').localeCompare(b.date||'') || ((a.time||'~').localeCompare(b.time||'~')) || ((a.id||0)-(b.id||0)); });
		const currentUser=localStorage.getItem('username')||''; const adminName='{{ config.admin_name }}'; const isAdmin = [adminName,'Administrator','admin'].includes(currentUser);
		out.forEach(r=>{
			if(r.isRule){ const row=document.createElement('div'); row.className='group p-2 rounded border bg-white dark:bg-slate-800'; const meta = (r.time? ('at '+escapeHtml(fmtTime(r.time))+' · ') : '')+escapeHtml(r.creator||''); const canEdit = (function(){ const currentUser=localStorage.getItem('username')||''; const adminName='{{ config.admin_name }}'; const isAdmin = [adminName,'Administrator','admin'].includes(currentUser); return isAdmin || (r.creator && r.creator===currentUser); })(); const catClass = r.category?('rem-cat-dot-'+r.category):''; const dot = `<span class="inline-block w-2.5 h-2.5 rounded-full mr-1 flex-shrink-0 ${catClass||'bg-gray-400'}"></span>`; row.innerHTML = `<div class="font-semibold flex items-center">${dot}${escapeHtml(r.title)}<span class="ml-2 text-[11px] px-1 py-0.5 rounded border bg-white dark:bg-slate-800 text-gray-600">Recurring</span>${canEdit?`<button type="button" data-edit-rule="${r.id}" class="ml-2 text-[11px] px-1 py-0.5 rounded border bg-white dark:bg-slate-800 hover:bg-blue-50 dark:hover:bg-slate-600" aria-label="Edit recurring">✎</button>`:''}${canEdit?`<button type="button" data-delete-rule="${r.id}" class="ml-1 text-[11px] px-1 py-0.5 rounded border bg-white dark:bg-slate-800 hover:bg-red-50 dark:hover:bg-red-900/30" aria-label="Delete recurring">✕</button>`:''}</div><div class="text-xs text-gray-500">${escapeHtml(formatRepeat(r.interval, r.unit, r.end_date))}${meta? ' · '+meta:''}${r.category? ' · '+escapeHtml(r.category):''}</div>`; listWrap.appendChild(row); }
				else {
					const canEdit = isAdmin || (r.creator && r.creator===currentUser);
					const row=document.createElement('div');
					row.className='group flex items-start gap-2 p-2 rounded border hover:bg-gray-50 dark:hover:bg-slate-700';
					row.setAttribute('data-reminder-row','');
					row.setAttribute('data-id', r.id);
					row.setAttribute('data-date', r.date);
					const catClass = r.category?('rem-cat-dot-'+r.category):'';
					const dot = `<span class="inline-block w-2.5 h-2.5 rounded-full mr-1 flex-shrink-0 ${catClass||'bg-gray-400'}"></span>`;
					const timeFrag = r.time?` <span class=\"ml-1 text-[10px] text-blue-600 dark:text-blue-300\">${fmtTime(r.time)}</span>`:'';
					const meta = `${r.date}${timeFrag} · ${escapeHtml(r.creator||'')}${r.category?' · '+escapeHtml(r.category):''}`;
					row.innerHTML=`${canEdit?`<label class=\"mt-1\"><input type=\"checkbox\" class=\"reminderChk\" value=\"${r.id}\" aria-label=\"Select reminder\"></label>`:''}
						<div class=\"flex-1 ${canEdit?'cursor-pointer':''}\" data-edit>
							<div class=\"font-semibold flex items-center\">${dot}${escapeHtml(r.title)}${canEdit?`<button type=\"button\" class=\"ml-2 text-[11px] px-1 py-0.5 rounded border bg-white dark:bg-slate-800 hover:bg-blue-50 dark:hover:bg-slate-600 editBtn hidden group-hover:inline\" aria-label=\"Edit\">✎</button>`:''}</div>
							<div class=\"text-xs text-gray-500 dark:text-gray-400\">${meta}</div>
							${r.description?`<div class=\"text-xs text-gray-600 dark:text-gray-300 whitespace-pre-wrap mt-1\">${escapeHtml(r.description)}</div>`:''}
						</div>
						${canEdit?`<button type=\"button\" class=\"opacity-0 group-hover:opacity-100 transition text-xs px-2 py-1 rounded border bg-white dark:bg-slate-800 hover:bg-red-50 dark:hover:bg-red-900/30 deleteOne\" aria-label=\"Delete\">✕</button>`:''}`;
					listWrap.appendChild(row);
					// Bind single-item edit when allowed (delete handled by delegated listener)
					if(canEdit){
						const editTarget = row.querySelector('[data-edit]');
						const editBtn = row.querySelector('.editBtn');
						if(editTarget){ editTarget.addEventListener('dblclick',()=> openForm('edit', r.date, r)); }
						if(editBtn){ editBtn.addEventListener('click',()=> openForm('edit', r.date, r)); }
					}
				}
		});
		// bind rule edit/delete
		bindRuleEdits();
		listWrap.querySelectorAll('[data-delete-rule]')?.forEach(btn=>{
			btn.addEventListener('click', async ()=>{
				const rid=parseInt(btn.getAttribute('data-delete-rule')); const creator=localStorage.getItem('username')||'';
				const res = await window.remindersApi.deleteRule(rid, creator);
				if(res && res.ok){ const dateStr=getSelectedDate(); await fetchMonth(dateStr, true); const d=new Date(dateStr); const key=d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0'); recalcMonth(key); updateCalendarBadges(); renderList(); toast('Recurring rule deleted','success'); }
				else { toast((res&&res.error)||'Delete failed','error'); }
			});
		});
			// Initialize bulk bar visibility on render
			updateBulkUI();
	}

	if(currentScope==='month'){ const prev=new Date(dObj.getFullYear(), dObj.getMonth()-1,1); const next=new Date(dObj.getFullYear(), dObj.getMonth()+1,1); fetchMonth(prev.toISOString().slice(0,10)); fetchMonth(next.toISOString().slice(0,10)); }
	updateCategorySummary(baseItems); }
	// Category summary pills (buttons) click handler using data-cat attribute
	const catSummaryEl=document.getElementById('reminderCategorySummary');
	if(catSummaryEl && !catSummaryEl.dataset.clickReady){
		catSummaryEl.dataset.clickReady='1';
		catSummaryEl.addEventListener('click', e=>{ const b=e.target.closest('button[data-cat]'); if(!b) return; const val=b.getAttribute('data-cat'); activeCategory = (val===activeCategory)?'ALL':val; renderList(); });
	}
	function updateCategorySummary(scopeList){
		const wrap = document.getElementById('reminderCategorySummary');
		if (!scopeList.length) {
			// still consider recurring rules in scope
			const mkey=(new Date(getSelectedDate())).getFullYear()+'-'+String((new Date(getSelectedDate())).getMonth()+1).padStart(2,'0');
			const cache=monthCache[mkey]||{}; const rules=cache.recurring_rules||[];
			if(!rules.length){ wrap.innerHTML=''; return; }
		}
		const counts = {};
		scopeList.forEach(r => { if (r.category) counts[r.category] = (counts[r.category] || 0) + 1; });
		// include recurring rules in-scope
		const dateStr=getSelectedDate(); const dObj=new Date(dateStr);
		const within = (ds)=>{ if(currentScope==='day') return ds===dateStr; if(currentScope==='week'){ const base=dObj; const mon=new Date(base.getFullYear(), base.getMonth(), base.getDate()-((base.getDay()+6)%7)); const end=new Date(mon.getFullYear(), mon.getMonth(), mon.getDate()+6); const rd=new Date(ds); return rd>=mon && rd<=end; } return true; };
		const mkey=dObj.getFullYear()+'-'+String(dObj.getMonth()+1).padStart(2,'0'); const cache=monthCache[mkey]||{};
		(cache.recurring_rules||[]).forEach(rr=>{ if(!rr.category) return; const inScope = (rr.dates||[]).filter(within).length; if(inScope){ counts[rr.category]=(counts[rr.category]||0)+inScope; } });
		const ordered = Object.entries(counts).sort((a, b) => b[1] - a[1]);
		// Clear previous content
		wrap.innerHTML = '';
		// Create "All" button (count includes singles + recurring-in-scope)
		const allBtn = document.createElement('button');
		allBtn.type = "button";
		allBtn.setAttribute('data-cat', 'ALL');
		allBtn.className = 'rem-cat-pill inline-flex items-center gap-1 px-2 py-0.5 rounded border bg-white text-xs hover:bg-blue-50' +
			(activeCategory === 'ALL' ? ' ring-1 ring-blue-500 bg-blue-50' : '');
		const totalCount = Object.values(counts).reduce((a,b)=>a+b, 0);
		allBtn.textContent = `All: ${totalCount}`;
		wrap.appendChild(allBtn);
		// Build key→label lookup from reminderCategoriesData
		let catDataEl = document.getElementById('reminderCategoriesData');
		let catLabelMap = {};
		try {
			const cats = JSON.parse(catDataEl?.textContent || '[]');
			cats.forEach(c => { if(c && c.key) catLabelMap[c.key] = c.label || c.key; });
		} catch(e) {}
		// Create category buttons
		ordered.forEach(([k, v]) => {
			const act = activeCategory === k;
			const btn = document.createElement('button');
			btn.type = "button";
			btn.setAttribute('data-cat', k);
			btn.className = 'rem-cat-pill inline-flex items-center gap-1 px-2 py-0.5 rounded border bg-white text-xs hover:bg-blue-50' +
				(act ? ' ring-1 ring-blue-500 bg-blue-50' : '');
			// Create dot span
			const dot = document.createElement('span');
			dot.className = `w-2 h-2 rounded-full rem-cat-dot-${k}`;
			btn.appendChild(dot);
			// Add category label and count
			const label = document.createElement('span');
			label.innerHTML = `${escapeHtml(catLabelMap[k] || k)}: ${v}`;
			btn.appendChild(label);
			wrap.appendChild(btn);
		});
	}
	function paintItems(list){ const currentUser=localStorage.getItem('username')||''; const adminName='{{ config.admin_name }}'; const isAdmin = [adminName,'Administrator','admin'].includes(currentUser); const selections=new Set(); listWrap.innerHTML=''; bulkBar.classList.add('hidden'); bulkCount.textContent='0'; if(!list.length){ listWrap.innerHTML='<div class="text-gray-500">No reminders</div>'; return;} list.sort((a,b)=> (a.date.localeCompare(b.date)) || ((a.time||'~').localeCompare(b.time||'~')) || (a.id-b.id));
	function fmtTime(val){ if(!val) return ''; if(window.REMINDERS_TIME_FORMAT==='24h') return val; const [h,m]=val.split(':'); let hh=parseInt(h,10); const ap=hh>=12?'PM':'AM'; hh = (hh%12)||12; return hh+':'+m+' '+ap; }
	list.forEach(r=>{ const canEdit = isAdmin || (r.creator && r.creator===currentUser); const row=document.createElement('div'); row.className='group flex items-start gap-2 p-2 rounded border hover:bg-gray-50 dark:hover:bg-slate-700'; const catClass = r.category?('rem-cat-dot-'+r.category):''; const dot = `<span class="inline-block w-2.5 h-2.5 rounded-full mr-1 flex-shrink-0 ${catClass||'bg-gray-400'}"></span>`; const timeFrag = r.time?` <span class=\"ml-1 text-[10px] text-blue-600 dark:text-blue-300\">${fmtTime(r.time)}</span>`:''; const meta = `${r.date}${timeFrag} · ${escapeHtml(r.creator||'')}${r.category?' · '+escapeHtml(r.category):''}`; row.innerHTML=`${canEdit?`<label class=\"mt-1\"><input type=\"checkbox\" class=\"reminderChk\" value=\"${r.id}\" aria-label=\"Select reminder\"></label>`:''}<div class=\"flex-1 ${canEdit?'cursor-pointer':''}\" data-edit><div class=\"font-semibold flex items-center\">${dot}${escapeHtml(r.title)}${canEdit?`<button type=\"button\" class=\"ml-2 text-[11px] px-1 py-0.5 rounded border bg-white dark:bg-slate-800 hover:bg-blue-50 dark:hover:bg-slate-600 editBtn hidden group-hover:inline\" aria-label=\"Edit\">✎</button>`:''}</div><div class=\"text-xs text-gray-500 dark:text-gray-400\">${meta}</div>${r.description?`<div class=\"text-xs text-gray-600 dark:text-gray-300 whitespace-pre-wrap mt-1\">${escapeHtml(r.description)}</div>`:''}</div>${canEdit?`<button type=\"button\" class=\"opacity-0 group-hover:opacity-100 transition text-xs px-2 py-1 rounded border bg-white dark:bg-slate-800 hover:bg-red-50 dark:hover:bg-red-900/30 deleteOne\" aria-label=\"Delete\">✕</button>`:''}`; if(canEdit){ const editTarget=row.querySelector('[data-edit]'); editTarget.addEventListener('dblclick',()=> openForm('edit', r.date, r)); row.querySelector('.editBtn').addEventListener('click',()=> openForm('edit', r.date, r)); row.querySelector('.deleteOne').addEventListener('click',()=>{ const creator=currentUser; const snapshot=JSON.parse(JSON.stringify(r)); window.remindersApi.removeMany([r.id],creator).then(resp=>{ if(resp.ok){ Object.values(monthCache).forEach(mc=>{ mc.reminders=mc.reminders.filter(x=>x.id!==r.id); }); toast('Deleted (undo available)','success'); const host=document.getElementById('toastHost'); if(host){ const undo=document.createElement('div'); undo.className='pointer-events-auto px-3 py-2 rounded shadow text-sm bg-blue-600 text-white cursor-pointer'; undo.textContent='Undo delete'; undo.onclick=()=>{ const d=new Date(snapshot.date); const key=d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0'); if(!monthCache[key]) monthCache[key]={reminders:[],counts:{},categories_counts:{}}; monthCache[key].reminders.push(snapshot); renderList(); updateCalendarBadges(); undo.remove(); }; host.appendChild(undo); setTimeout(()=>undo.remove(),6000);} renderList(); updateCalendarBadges(); } else toast('Delete failed','error');}); }); }
	listWrap.appendChild(row); }); function updateBulk(){ bulkCount.textContent=selections.size; bulkIds.value=Array.from(selections).join(','); bulkBar.classList.toggle('hidden', !selections.size); } listWrap.querySelectorAll('.reminderChk').forEach(cb=>cb.addEventListener('change',()=>{ const id=parseInt(cb.value); if(cb.checked) selections.add(id); else selections.delete(id); updateBulk(); })); document.getElementById('bulkClearSel').onclick=()=>{ selections.clear(); listWrap.querySelectorAll('.reminderChk').forEach(c=>c.checked=false); updateBulk(); }; const bulkForm=document.getElementById('bulkDeleteForm'); if(bulkForm && !bulkForm.dataset.ajax){ bulkForm.dataset.ajax='1'; bulkForm.addEventListener('submit', e=>{ e.preventDefault(); const ids=Array.from(selections); if(!ids.length) return; const creator=localStorage.getItem('username')||''; window.remindersApi.removeMany(ids,creator).then(resp=>{ if(!resp.ok){ toast('Delete failed','error'); return;} Object.values(monthCache).forEach(mc=>{ mc.reminders=mc.reminders.filter(r=>!ids.includes(r.id)); }); toast('Deleted '+ids.length,'success'); selections.clear(); bulkCount.textContent='0'; bulkBar.classList.add('hidden'); renderList(); updateCalendarBadges(); }); }); }
	}

	// Add edit handling for recurring rule cards
	function bindRuleEdits(){
		listWrap.querySelectorAll('[data-edit-rule]')?.forEach(btn=>{
			btn.addEventListener('click', ()=>{
				const rid = parseInt(btn.getAttribute('data-edit-rule'));
				const mkey=display.getFullYear()+'-'+String(display.getMonth()+1).padStart(2,'0');
				const cache=monthCache[mkey]||{}; const rr=(cache.recurring_rules||[]).find(x=>x.id===rid);
				if(!rr) return;
				// Populate form for rule editing
				inlineForm.reset(); editingId=null; window.__editingRuleId = rid;
				inlineForm.querySelector('[name=title]').value = rr.title||'';
				inlineForm.querySelector('[name=description]').value = rr.description||'';
				if(rr.time) inlineForm.querySelector('[name=time]').value = rr.time;
				if(categorySelect && rr.category) categorySelect.value = rr.category;
				if(recChk){ recChk.checked = true; }
				inlineForm.querySelector('[name=rec_interval]').value = rr.interval||1;
				inlineForm.querySelector('[name=rec_unit]').value = rr.unit||'day';
				if(rr.end_date) inlineForm.querySelector('[name=rec_end_date]').value = rr.end_date;
				// set date field to rule start_date so user can change anchor
				inlineForm.querySelector('[name=date]').value = rr.start_date || getSelectedDate();
				toggleRecurringFields();
				inlineWrap.classList.remove('hidden');
			});
		});
	}
	function onMonthChange(delta){ 
		const oldMonth = display.getMonth(); 
		display = new Date(display.getFullYear(), display.getMonth()+delta, 1); 
		buildAndEnsure(); 
		// When month changes, show entire month and switch to first day of that month
		const firstDayOfMonth = display.getFullYear()+'-'+String(display.getMonth()+1).padStart(2,'0')+'-01';
		setSelectedDate(firstDayOfMonth);
		// Reset scope to month to show full month list
		currentScope='month'; 
		localStorage.setItem('remindersScope', currentScope);
		scopeBar.querySelectorAll('.scopeBtn').forEach(btn=>{ 
			const act=btn.getAttribute('data-scope')===currentScope; 
			btn.className='px-2 py-0.5 text-xs rounded border scopeBtn '+(act?'border-blue-500 text-blue-600 bg-blue-50':'border-gray-300 bg-white text-gray-600 hover:bg-gray-100'); 
		}); 
		renderList(); 
	}

	// Fix: when reloading page after viewing another month, ensure selected date's month matches display month cache and list uses current month not stale prior selection
	function normalizeAfterInitialLoad(){
		const selected = getSelectedDate();
		const selDate = new Date(selected);
		if(selDate.getMonth() !== display.getMonth() || selDate.getFullYear() !== display.getFullYear()){
			// Reset selected date to today's date within current display month
			const today=new Date();
			if(today.getMonth()===display.getMonth() && today.getFullYear()===display.getFullYear()){
				setSelectedDate(today.toISOString().slice(0,10));
			}else{
				// fallback to first day of display month
				const firstDayOfMonth = display.getFullYear()+'-'+String(display.getMonth()+1).padStart(2,'0')+'-01';
				setSelectedDate(firstDayOfMonth);
			}
		}
	}
	prevBtn.addEventListener('click', ()=> onMonthChange(-1));
	nextBtn.addEventListener('click', ()=> onMonthChange(1));
	function buildAndEnsure(){ const mk=display.getFullYear()+'-'+String(display.getMonth()+1).padStart(2,'0'); const have = monthCache[mk]; if(!have || !have.recurring_rules){ fetchMonth(mk+'-01', true).then(()=>{ renderCalendar(); renderList(); }); } renderCalendar(); }
	const startDate = getSelectedDate(); setSelectedDate(startDate); buildAndEnsure(); normalizeAfterInitialLoad(); renderList();
	// No dropdown filter now
	bulkUser.value = localStorage.getItem('username')||'';
	
	// Re-render list when user switches to update edit/delete visibility
	document.addEventListener('user-switched', function() {
		bulkUser.value = localStorage.getItem('username')||'';
		renderList(); // This will recalculate canEdit for all items
	});
	}
	})();
		</script>
	</div> <!-- /right col -->
</div> <!-- /grid -->
<script>
	const d = new Date();
	document.getElementById('today').textContent = d.toLocaleString();
		// Toggle visibility of Notice form based on current user (admin)
		(function(){
			const nf = document.getElementById('noticeForm');
			if(!nf) return;
			const adminName = '{{ config.admin_name }}';
			function update(){
				const current = localStorage.getItem('username');
				if (!(current === adminName || current === 'Administrator' || current === 'admin')) {
					nf.style.display = 'none';
				} else {
					nf.style.display = '';
				}
				const userField = nf.querySelector('input[name="user"]');
				if (userField) userField.value = current || '';
			}
			update();
			document.getElementById('userSwitcher')?.addEventListener('change', update);
		})();
</script>
<script>
// Enhance chips for member personal statuses with per-name coloring; default and hide admin for Who is Home quick controls
(function(){
	// Personal member statuses: give each member a stable color
	function colorPersonalChips(){
		const chips = document.querySelectorAll('#memberStatusChips span[data-name]');
		const palette = ['#DBEAFE','#FEF3C7','#DCFCE7','#FCE7F3','#E9D5FF','#FFEDD5','#E5E7EB'];
		const names = Array.from(new Set(Array.from(chips).map(el=>el.getAttribute('data-name'))));
		names.forEach((name, idx)=>{
			const els = Array.from(chips).filter(e=>e.getAttribute('data-name')===name);
			const bg = palette[idx % palette.length];
			els.forEach(el=>{ el.style.backgroundColor = bg; el.style.borderColor = '#CBD5E1'; });
		});
	}
	colorPersonalChips();
	// Helper to update Who is Home quick controls and member status forms for current user
	function updateHomeAndStatusUI(){
		const current = localStorage.getItem('username') || '';
		const adminName = '{{ config.admin_name }}';
		// Hidden inputs
		document.getElementById('whoName')?.setAttribute('value', current);
		document.getElementById('whoNameClear')?.setAttribute('value', current);
		document.getElementById('memberStatusName')?.setAttribute('value', current);
		document.getElementById('memberStatusDeleteName')?.setAttribute('value', current);
		// Update user chip
		const chip = document.getElementById('memberStatusUserChip');
		if (chip){ chip.textContent = current ? current : ''; }
		// Admin: hide quick controls and personal status editor
		const isAdmin = (current === adminName || current === 'Administrator' || current === 'admin');
		const quick = document.getElementById('whoUnifiedForm');
		const msForm = document.getElementById('memberStatusForm');
		const msDel = document.getElementById('memberStatusDelete');
		const whoCard = document.getElementById('whoHomeCard');
		const personalCard = document.getElementById('personalStatusCard');
		if (isAdmin){
			whoCard?.classList.add('hidden');
			personalCard?.classList.add('hidden');
			return; // hide entire cards for admin
		}else{
			whoCard?.classList.remove('hidden');
			personalCard?.classList.remove('hidden');
			quick?.classList.remove('hidden');
			msForm?.classList.remove('hidden');
		}
		// Show delete button only if current user has a status chip
		const chips = document.querySelectorAll('#memberStatusChips span[data-name]');
		const hasStatus = Array.from(chips).some(el => el.getAttribute('data-name') === current);
		if (msDel){ msDel.classList.toggle('hidden', !hasStatus); }
	}
	// Initial paint
	updateHomeAndStatusUI();
	// Update on user switch without refresh (global event from base.html)
	document.addEventListener('user-switched', updateHomeAndStatusUI);

	// Unified Who is Home form clear button handling
	const whoClearBtn = document.getElementById('whoClearBtn');
	const whoUnifiedForm = document.getElementById('whoUnifiedForm');
	if (whoClearBtn && whoUnifiedForm){
		whoClearBtn.addEventListener('click', function(){
			const actionField = document.getElementById('whoAction');
			if(actionField){ actionField.value = 'clear'; }
			whoUnifiedForm.submit();
		});
		const updateBtn = document.getElementById('whoUpdateBtn');
		if(updateBtn){
			updateBtn.addEventListener('click', function(){
				const actionField = document.getElementById('whoAction');
				if(actionField){ actionField.value = 'update'; }
			});
		}
	}
})();
</script>
<script>
// AJAX enhancement for Who is Home & Personal Status forms (no page reload)
(function(){
	// Skip if Who is Home feature disabled
	if(!document.getElementById('whoUnifiedForm') && !document.getElementById('whoStatusList')) return;
		// Family members injected from server
		const FAMILY_MEMBERS = JSON.parse(document.getElementById('familyMembersData').textContent || '[]');
		function fetchJson(url, opts){
		opts = opts || {}; opts.headers = Object.assign({'X-Requested-With':'fetch'}, opts.headers||{});
		return fetch(url, opts).then(r=>r.json().catch(()=>({error:'Bad JSON'})));
	}
	const whoForm = document.getElementById('whoUnifiedForm');
	const memberForm = document.getElementById('memberStatusForm');
	const memberDel = document.getElementById('memberStatusDelete');
	const whoList = document.getElementById('whoStatusList');
	const memberChips = document.getElementById('memberStatusChips');
	// Safe toast alias (previous inline function removed) to avoid ReferenceError breaking listeners
	const toast = (msg,type)=>{ if(window.globalToast) window.globalToast(msg,type); else console.log('[toast]', type||'', msg); };
	function currentUser(){ return localStorage.getItem('username')||''; }
	function updateWhoDOM(data){
		if(!data) return;
		let statuses={};
		if(Array.isArray(data.entries)) data.entries.forEach(e=>{ statuses[e.name]=e.status; });
		else if(data.who_statuses && typeof data.who_statuses==='object') statuses=data.who_statuses;
		// Use requestAnimationFrame to batch DOM updates and prevent layout thrashing
		requestAnimationFrame(()=>{
			whoList.querySelectorAll('[data-member]').forEach(container=>{
				const member=container.getAttribute('data-member');
				const st=statuses[member];
				const pill=container.querySelector('.status-pill');
				if(!pill) return;
				// Update text content only if changed
				const newText=st||'—';
				if(pill.textContent!==newText) pill.textContent=newText;
				// Compute new classes
				const baseClasses=['px-1.5','py-0.5','rounded','text-[10px]','leading-none','status-pill'];
				let colorClasses=[];
				if(st==='Home'){ colorClasses=['bg-green-100','text-green-700','border','border-green-300']; }
				else if(st==='Away'){ colorClasses=['bg-gray-100','text-gray-600','border','border-gray-300']; }
				else if(st==='Out'){ colorClasses=['bg-amber-100','text-amber-700','border','border-amber-300']; }
				else if(st==='Traveling'){ colorClasses=['bg-indigo-100','text-indigo-700','border','border-indigo-300']; }
				else if(st){ colorClasses=['bg-blue-100','text-blue-700','border','border-blue-300']; }
				else{ colorClasses=['bg-gray-100','text-gray-500','border','border-gray-200']; }
				// Replace className entirely to avoid classList manipulation overhead
				pill.className=baseClasses.concat(colorClasses).join(' ');
			});
		});
	}
	function recolorMemberChips(){
		const chips = memberChips.querySelectorAll('span[data-name]');
		const palette=['#DBEAFE','#FEF3C7','#DCFCE7','#FCE7F3','#E9D5FF','#FFEDD5','#E5E7EB'];
		const names=[...new Set(Array.from(chips).map(c=>c.dataset.name))];
		names.forEach((n,i)=>{ const bg=palette[i%palette.length]; chips.forEach(ch=>{ if(ch.dataset.name===n){ ch.style.backgroundColor=bg; ch.style.borderColor='#CBD5E1'; } }); });
	}
		function updateMemberStatusDOM(data){
			if(!data) return;
			let entries=[];
			if(Array.isArray(data.entries)) entries=data.entries;
			else if(data.member_statuses && typeof data.member_statuses==='object'){
				entries = Object.entries(data.member_statuses).map(([name,text])=>({name,text}));
			}
			memberChips.innerHTML='';
			entries.forEach(e=>{ if(!e.text) return; const span=document.createElement('span'); span.dataset.name=e.name; span.className='px-2 py-1 rounded border bg-white shadow-sm text-xs'; span.innerHTML=e.text+' <span class="text-gray-500 text-[10px]">— '+e.name+'</span>'; memberChips.appendChild(span); });
		recolorMemberChips();
		const user=currentUser();
		const has=Array.from(memberChips.querySelectorAll('span[data-name]')).some(el=>el.dataset.name===user);
		memberDel.classList.toggle('hidden', !has);
	}
		if(whoForm){ whoForm.addEventListener('submit', e=>{ e.preventDefault(); const fd=new FormData(whoForm); const payload=new URLSearchParams(fd); const actionField=document.getElementById('whoAction'); const actVal=actionField?.value; const targetUrl=whoForm.getAttribute('action'); fetchJson(targetUrl,{method:'POST',body:payload}).then(resp=>{ if(resp && resp.ok){ updateWhoDOM(resp); const resType = resp.result || (actVal==='clear'?'cleared':'updated'); if(resType==='cleared') toast('Status cleared','success'); else if(resType==='none') toast('No status to clear','info'); else toast('Status updated','success'); if(actionField) actionField.value='update'; } else toast(resp && resp.error || 'Update failed','error'); }); }); }
	const whoClear=document.getElementById('whoClearBtn');
	if(whoClear){
		whoClear.addEventListener('click', e=>{
			e.preventDefault();
			if(!whoForm) return;
			const nameVal = whoForm.querySelector('[name=name]')?.value || '';
			const payload = new URLSearchParams();
			payload.append('action','clear');
			payload.append('name', nameVal);
			fetchJson(whoForm.getAttribute('action'), { method:'POST', body: payload }).then(resp=>{
				if(resp && resp.ok){
					updateWhoDOM(resp);
					if(resp.result==='cleared') toast('Status cleared','success');
					else if(resp.result==='none') toast('No status to clear','info');
					else toast('Status updated','success');
				} else {
					toast((resp && resp.error) || 'Update failed','error');
				}
			});
		});
	}
		if(memberForm){ memberForm.addEventListener('submit', e=>{ e.preventDefault(); const input=memberForm.querySelector('[name=text]'); const val=(input?.value||'').trim(); if(!val){ toast('Cannot save empty status','info'); return; } const fd=new FormData(memberForm); const qs=new URLSearchParams(fd); const targetUrl=memberForm.getAttribute('action'); fetchJson(targetUrl,{method:'POST',body:qs}).then(resp=>{ if(resp && resp.ok){ updateMemberStatusDOM(resp); memberForm.reset(); memberForm.querySelector('[name=name]').value=currentUser(); toast('Status saved','success'); } else { if(resp && resp.error==='Empty status'){ toast('Cannot save empty status','info'); } else toast(resp && resp.error || 'Save failed','error'); } }); }); }
		if(memberDel){ memberDel.addEventListener('submit', e=>{ e.preventDefault(); const fd=new FormData(memberDel); const qs=new URLSearchParams(fd); const targetUrl=memberDel.getAttribute('action'); fetchJson(targetUrl,{method:'POST',body:qs}).then(resp=>{ if(resp && resp.ok){ updateMemberStatusDOM(resp); toast('Status removed','success'); } else toast(resp && resp.error || 'Remove failed','error'); }); }); }
	// Initialize name fields
	const cur=currentUser();
	document.getElementById('whoName')?.setAttribute('value', cur);
	document.getElementById('memberStatusName')?.setAttribute('value', cur);
	document.getElementById('memberStatusDeleteName')?.setAttribute('value', cur);
})();
</script>
{% endblock %}