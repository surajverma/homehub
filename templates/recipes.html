{% extends "base.html" %}
{% block content %}
<div class="mx-auto">
    <h2 class="text-xl font-bold mb-4">Recipe Book</h2>
    <form method="POST" action="/recipes" class="mb-4 card p-4">
        <input type="hidden" name="recipe_id" value="{{ form_recipe_id if form_recipe_id is defined else '' }}">
        <input type="text" name="title" value="{{ form_title if form_title is defined else '' }}" class="w-full p-2 border rounded mb-2" placeholder="Recipe title..." required>
        <div class="flex gap-2 mb-2">
            <input type="url" name="link" id="link-input" value="{{ form_link if form_link is defined else '' }}" class="flex-1 p-2 border rounded" placeholder="Link (optional)">
            <button type="submit" formaction="/recipes/scrape" formnovalidate id="scrape-btn" class="btn btn-secondary px-4" title="Enter a URL and click here to auto-fill the recipe details"><i class="fa-solid fa-wand-magic-sparkles"></i></button>
        </div>
        <textarea name="ingredients" class="w-full p-2 border rounded mb-2" placeholder="Ingredients...">{{ form_ingredients if form_ingredients is defined else '' }}</textarea>
        <textarea name="instructions" class="w-full p-2 border rounded mb-2" placeholder="Instructions...">{{ form_instructions if form_instructions is defined else '' }}</textarea>
    <input type="hidden" name="creator" id="creator">
        <button type="submit" class="btn btn-primary">{{ 'Save' if form_recipe_id is defined else 'Add Recipe' }}</button>
    </form>
    <ul>
        {% for recipe in recipes %}
        <li class="card p-4 mb-2">
            <div class="font-semibold text-lg">{{ recipe.title }}</div>
            {% if recipe.link %}
            <a href="{{ recipe.link }}" class="text-blue-600 underline" rel="noopener noreferrer" target="_blank">Link</a>
            {% endif %}
            <div class="text-xs text-gray-500">By {{ recipe.creator }} at {{ recipe.timestamp.strftime('%Y-%m-%d %H:%M') }}</div>
            <div class="mt-2"><strong>Ingredients:</strong>
                <div class="prose max-w-none whitespace-pre-wrap">{{ recipe.ingredients }}</div>
            </div>
            <div class="mt-2"><strong>Instructions:</strong>
                <div class="prose max-w-none whitespace-pre-wrap">{{ recipe.instructions }}</div>
            </div>
            <div class="mt-2 flex gap-2">
                <a class="btn btn-secondary" href="/recipes/edit/{{ recipe.id }}">Edit</a>
                <form method="POST" action="/recipes/delete/{{ recipe.id }}" class="delete-form" data-creator="{{ recipe.creator }}">
                    <input type="hidden" name="user">
                    <button type="submit" class="btn btn-danger">Delete</button>
                </form>
            </div>
        </li>
        {% endfor %}
    </ul>
</div>
<script>
document.getElementById('creator').value = localStorage.getItem('username');
document.querySelectorAll('input[name="user"]').forEach(i=> i.value = localStorage.getItem('username'));
// Client-side validation: require ingredients or instructions
(function(){
    const form = document.querySelector('form[method="POST"]');
    form.addEventListener('submit', function(e){
        const btn = e.submitter;
        const btnAction = btn ? btn.getAttribute('formaction') : null;
        if (btnAction && btnAction.includes('scrape')) {
            return; // Skip validation for scrape requests
        }
        const ing = (form.querySelector('textarea[name="ingredients"]').value||'').trim();
        const ins = (form.querySelector('textarea[name="instructions"]').value||'').trim();
        if(!ing && !ins){
            e.preventDefault();
            alert('Please add ingredients or instructions (or both).');
        }
    });
})();
// Hide delete for non-owners
(function(){
    const adminName='{{ config.admin_name }}';
    const current=localStorage.getItem('username');
    document.querySelectorAll('.delete-form').forEach(f=>{
        const c=f.getAttribute('data-creator');
        if(!(current===c||current===adminName||current==='Administrator'||current==='admin')) f.style.display='none';
    });
})();
</script>
{% endblock %}
