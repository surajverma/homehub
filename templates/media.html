{% extends "base.html" %}
{% block content %}
<div class="mx-auto">
    <h2 class="text-xl font-bold mb-4">Media Downloader</h2>
    <form method="POST" class="mb-4 grid gap-2 md:grid-cols-12 grid-cols-1 items-end">
        <input type="url" name="url" class="w-full p-2 border rounded md:col-span-6" placeholder="Paste media URL..." required>
        <select name="format" class="p-2 border rounded md:col-span-2">
            <option value="mp4">MP4 (video)</option>
            <option value="mp3">MP3 (audio)</option>
        </select>
        <select name="quality" class="p-2 border rounded md:col-span-2">
            <option value="best">Best Available</option>
            <option value="bestvideo[height<=1080]+bestaudio/best[height<=1080]">Up to 1080p</option>
            <option value="bestvideo[height<=720]+bestaudio/best[height<=720]">Up to 720p</option>
        </select>
    <input type="hidden" name="creator" id="creator">
    <button type="submit" class="btn btn-primary md:col-span-2">Download</button>
    </form>
        <ul>
        {% for media in media_list %}
    <li class="card p-4 mb-2 flex flex-wrap gap-2 items-center" data-id="{{ media.id }}">
            <span class="flex-1 truncate">{{ media.title }}</span>
            {% if media.status == 'pending' %}
        <span class="px-2 py-1 rounded bg-yellow-100 text-yellow-800 status-chip">Starting…</span>
        <span class="text-xs text-gray-500 progress-line">{{ media.progress or 'Will take a while…' }}</span>
                        {% elif media.filepath %}
                <a href="/media/preview/{{ media.filepath }}" target="_blank" rel="noopener noreferrer" class="btn btn-success" aria-label="Preview {{ media.filepath }} in new tab">
                    <i class="fa-solid fa-eye" aria-hidden="true"></i> Preview
                </a>
                <a href="/media/{{ media.filepath }}" class="btn btn-primary">
                    <i class="fa-solid fa-download" aria-hidden="true"></i> Download
                </a>
                        {% else %}
                <span class="px-2 py-1 rounded bg-red-100 text-red-800">Not available</span>
                        {% endif %}
                        <div class="text-xs text-gray-500">By {{ media.creator }} at {{ media.download_time.strftime('%Y-%m-%d %H:%M') }}</div>
            <form method="POST" action="/media/delete/{{ media.id }}" class="delete-form" data-creator="{{ media.creator }}">
                <input type="hidden" name="user">
                <button type="submit" class="btn btn-danger action-delete">Delete</button>
            </form>
                </li>
                {% endfor %}
        </ul>
</div>
<script>
document.getElementById('creator').value = localStorage.getItem('username');
document.querySelectorAll('input[name="user"]').forEach(i=> i.value = localStorage.getItem('username'));
// Hide delete buttons for unauthorized users
(function(){
    const adminName = '{{ config.admin_name }}';
    const current = localStorage.getItem('username');
    document.querySelectorAll('.delete-form').forEach(f => {
        const creator = f.getAttribute('data-creator');
        if (!(current === creator || current === adminName || current === 'Administrator' || current === 'admin')) {
            f.style.display = 'none';
        }
    });
})();
// Poll media progress
(function(){
    function poll(item){
        const id = item.getAttribute('data-id');
        fetch(`/media/status/${id}`).then(r=>r.json()).then(d=>{
            if (d.status === 'pending'){
                const p = item.querySelector('.progress-line');
                const chip = item.querySelector('.status-chip');
                if (p){
                    if (d.progress && /%$/.test(d.progress)){
                        chip.textContent = 'Downloading…';
                        p.textContent = d.progress;
                    } else {
                        chip.textContent = 'Starting…';
                        p.textContent = 'Will take a while…';
                    }
                }
                setTimeout(()=>poll(item), 2500);
            } else if (d.status === 'done' && d.filepath){
                // replace chip with Preview and Download links
                const chip = item.querySelector('.status-chip');
                if (chip){ 
                    chip.outerHTML = `
                        <a href="/media/preview/${d.filepath}" target="_blank" rel="noopener noreferrer" class="btn btn-success" aria-label="Preview ${d.filepath} in new tab">
                            <i class="fa-solid fa-eye" aria-hidden="true"></i> Preview
                        </a>
                        <a href="/media/${d.filepath}" class="btn btn-primary">
                            <i class="fa-solid fa-download" aria-hidden="true"></i> Download
                        </a>
                    `; 
                }
                const p = item.querySelector('.progress-line');
                if (p) p.textContent = '';
            } else if (d.status === 'error'){
                const chip = item.querySelector('.status-chip');
                if (chip){ chip.textContent = 'Error'; chip.className = 'px-2 py-1 rounded bg-red-100 text-red-800 status-chip'; }
            }
        }).catch(()=> setTimeout(()=>poll(item), 2000));
    }
    // Start polling for each pending row
    document.querySelectorAll('li[data-id]').forEach(li=>{
        if (li.querySelector('.status-chip')) poll(li);
    });
})();
</script>
{% endblock %}
