<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ config.instance_name }} - HomeHub</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='output.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Config-driven theme variables (takes priority) -->
    {% set pc = config.theme.primary_color.lstrip('#') %}
    <style id="config-theme-vars">
    /* Apply configured colors only when not in dark mode so dark overrides can take effect */
    :root:not([data-theme="dark"]), [data-theme="light"] {
        --primary-color: {{ config.theme.primary_color }};
        --secondary-color: {{ config.theme.secondary_color }};
        --background-color: {{ config.theme.background_color }};
        --card-background-color: {{ config.theme.card_background_color }};
        --text-color: {{ config.theme.text_color }};
        --sidebar-background-color: {{ config.theme.sidebar_background_color }};
        --sidebar-text-color: {{ config.theme.sidebar_text_color }};
        --sidebar-link-color: {{ config.theme.sidebar_link_color }};
        --sidebar-link-border-color: {{ config.theme.sidebar_link_border_color }};
        --sidebar-active-color: {{ config.theme.sidebar_active_color }};
    }
    </style>
    {% if pc|length == 6 %}
    <style>:root { --primary-rgb: {{ pc[0:2]|int(base=16) }}, {{ pc[2:4]|int(base=16) }}, {{ pc[4:6]|int(base=16) }}; }</style>
    {% endif %}
    <style>
    .btn, button.btn, a.btn { padding:0.5rem 0.75rem; font-size:0.875rem; font-weight:500; line-height:1.25rem; border-radius:0.375rem; display:inline-flex; align-items:center; gap:0.25rem; }
    .btn-primary { background:var(--primary-color); color:#fff; }
    .btn-primary:hover { filter:brightness(.92); }
    .btn-danger { background:#dc2626; color:#fff; }
    .btn-danger:hover { filter:brightness(.9); }
    /* Add semantic success/secondary mapped to Tailwind-like colors (via fixed or theme vars) */
    .btn-success { background:#16a34a; color:#fff; }
    .btn-success:hover { filter:brightness(.95); }
    .btn-secondary { background:#e5e7eb; color:#111827; }
    .btn-secondary:hover { filter:brightness(.97); }
    /* Sidebar collapse styles (desktop-only) + root hint to avoid flash */
    @media (min-width: 768px){
        .sidebar.collapsed,
        .prefers-sidebar-collapsed .sidebar{ width: 4rem; }
        .sidebar.collapsed .brand-name,
        .prefers-sidebar-collapsed .sidebar .brand-name{ display:none; }
        .sidebar.collapsed .nav-label,
        .prefers-sidebar-collapsed .sidebar .nav-label{ display:none; }
        .sidebar.collapsed #sidebarNav a,
        .prefers-sidebar-collapsed .sidebar #sidebarNav a{ padding-left: 1rem; padding-right: 1rem; justify-content: center; }
    }
    /* Ensure dark theme variable overrides reassert after config injection */
    [data-theme="dark"] {
        --background-color: #0f172a;
        --card-background-color: #111827;
        --text-color: #e5e7eb;
    }
    </style>
    <link rel="manifest" href="/manifest.webmanifest">
    <meta name="theme-color" content="{{ config.theme.primary_color }}">
    <!-- App icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="/static/icons/icon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/static/icons/icon-512.png">
    <!-- iOS PWA hints -->
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="apple-touch-icon" href="/static/icons/icon-192.png">
    {% block extra_head %}{% endblock %}
    <script>
        // Apply saved sidebar collapsed state ASAP to avoid flash before main JS runs
        (function(){
            try{
                var saved = localStorage.getItem('ui:sidebarCollapsed');
                var collapsed = (saved==='1' || saved==='true');
                if(collapsed){
                    document.documentElement.classList.add('prefers-sidebar-collapsed');
                }
                // Also set initial icon/title when DOM is ready, using the same preference
                function setInitialIcon(){
                    var icon = document.getElementById('collapseIcon');
                    if(icon){ icon.className = 'fa-solid '+(collapsed ? 'fa-angles-right' : 'fa-angles-left'); }
                    var btn = document.getElementById('toggleCollapse');
                    if(btn){ btn.title = collapsed ? 'Expand sidebar' : 'Collapse sidebar'; }
                }
                document.addEventListener('DOMContentLoaded', setInitialIcon, { once: true });
            }catch(e){}
        })();
    </script>
    <script>
        (function() {
            const mq = window.matchMedia('(prefers-color-scheme: dark)');
            const apply = () => document.documentElement.setAttribute('data-theme', mq.matches ? 'dark' : 'light');
            apply();
            try { mq.addEventListener('change', apply); } catch(e) { mq.addListener(apply); }
        })();
    </script>
</head>
<body class="min-h-screen">
    <div class="flex min-h-screen">
        <!-- Global JSON data for client scripts -->
        <script id="familyData" type="application/json">{{ config.family_members | tojson }}</script>
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar w-64 text-white flex flex-col fixed md:static inset-y-0 left-0 transform -translate-x-full md:translate-x-0 transition-transform duration-200 z-40">
            <div class="p-6 text-2xl font-bold border-b border-white/20 flex items-center justify-between" style="color: var(--sidebar-text-color);">
                <span class="brand-name">{{ config.instance_name }}</span>
                <div class="flex items-center gap-2">
                    <button id="toggleCollapse" class="hidden md:inline-flex text-white/90 hover:text-white" title="Collapse sidebar" aria-label="Collapse">
                        <i id="collapseIcon" class="fa-solid fa-angles-left"></i>
                    </button>
                    <button id="closeSidebar" class="md:hidden text-white/90 hover:text-white" aria-label="Close">✕</button>
                </div>
            </div>
            <nav class="flex-1 p-4 space-y-2 overflow-y-auto" id="sidebarNav">
                <a href="/" class="flex items-center gap-3 py-2 px-4 rounded sidebar-link" title="Welcome"><i class="fa-solid fa-house w-5 text-center"></i><span class="nav-label">Welcome</span></a>
                {% if config.feature_toggles.get('notes') %}<a href="/notes" class="flex items-center gap-3 py-2 px-4 rounded sidebar-link" title="Shared Notes"><i class="fa-solid fa-note-sticky w-5 text-center"></i><span class="nav-label">Shared Notes</span></a>{% endif %}
                {% if config.feature_toggles.get('shared_cloud') %}<a href="/upload" class="flex items-center gap-3 py-2 px-4 rounded sidebar-link" title="Shared Cloud"><i class="fa-solid fa-cloud w-5 text-center"></i><span class="nav-label">Shared Cloud</span></a>{% endif %}
                {% if config.feature_toggles.get('shopping_list') %}<a href="/shopping" class="flex items-center gap-3 py-2 px-4 rounded sidebar-link" title="Shopping List"><i class="fa-solid fa-cart-shopping w-5 text-center"></i><span class="nav-label">Shopping List</span></a>{% endif %}
                {% if config.feature_toggles.get('chores') %}<a href="/chores" class="flex items-center gap-3 py-2 px-4 rounded sidebar-link" title="To-Do/Chores"><i class="fa-solid fa-list-check w-5 text-center"></i><span class="nav-label">To-Do/Chores</span></a>{% endif %}
                {% if config.feature_toggles.get('recipes') %}<a href="/recipes" class="flex items-center gap-3 py-2 px-4 rounded sidebar-link" title="Recipe Book"><i class="fa-solid fa-utensils w-5 text-center"></i><span class="nav-label">Recipe Book</span></a>{% endif %}
                {% if config.feature_toggles.get('expiry_tracker') %}<a href="/expiry" class="flex items-center gap-3 py-2 px-4 rounded sidebar-link" title="Expiry Tracker"><i class="fa-solid fa-hourglass-half w-5 text-center"></i><span class="nav-label">Expiry Tracker</span></a>{% endif %}
                {% if config.feature_toggles.get('url_shortener') %}<a href="/shorten" class="flex items-center gap-3 py-2 px-4 rounded sidebar-link" title="URL Shortener"><i class="fa-solid fa-link w-5 text-center"></i><span class="nav-label">URL Shortener</span></a>{% endif %}
                {% if config.feature_toggles.get('media_downloader') %}<a href="/media" class="flex items-center gap-3 py-2 px-4 rounded sidebar-link" title="Media Downloader"><i class="fa-solid fa-download w-5 text-center"></i><span class="nav-label">Media Downloader</span></a>{% endif %}
                {% if config.feature_toggles.get('pdf_compressor') %}<a href="/pdfs" class="flex items-center gap-3 py-2 px-4 rounded sidebar-link" title="PDF Compressor"><i class="fa-solid fa-file-pdf w-5 text-center"></i><span class="nav-label">PDF Compressor</span></a>{% endif %}
                {% if config.feature_toggles.get('qr_generator') %}<a href="/qr" class="flex items-center gap-3 py-2 px-4 rounded sidebar-link" title="QR Generator"><i class="fa-solid fa-qrcode w-5 text-center"></i><span class="nav-label">QR Generator</span></a>{% endif %}
                {% if config.feature_toggles.get('expense_tracker', true) %}<a href="/expenses" class="flex items-center gap-3 py-2 px-4 rounded sidebar-link" title="Expense Tracker"><i class="fa-solid fa-wallet w-5 text-center"></i><span class="nav-label">Expense Tracker</span></a>{% endif %}
            </nav>
            <script>
            // Highlight active sidebar link
            (() => {
                const links = document.querySelectorAll('#sidebarNav .sidebar-link');
                const path = window.location.pathname.replace(/\/$/, '');
                links.forEach(link => {
                    let href = link.getAttribute('href').replace(/\/$/, '');
                    // Only mark active if exact match
                    if (href === path) {
                        link.classList.add('active');
                    } else {
                        link.classList.remove('active');
                    }
                });
            })();
            </script>
        </aside>
        <!-- Main Content -->
        <main class="main-content flex-1 p-4 md:p-8 overflow-y-auto md:ml-0 ml-0">
            <div class="max-w-none md:max-w-none mx-auto">
                <div class="sticky top-0 z-20 mb-4">
                    <div class="flex items-center flex-wrap gap-2">
                        <button id="openSidebar" class="md:hidden bg-blue-600 text-white px-3 py-2 rounded"><i class="fa-solid fa-bars"></i> Menu</button>
                        {% if not (hide_user_ui | default(false)) %}
                        <div class="ml-auto flex items-center gap-3 flex-wrap justify-end">
                            <div id="welcome" class="text-sm text-gray-600 truncate max-w-[50vw]"></div>
                            <div>
                                <label class="text-sm text-gray-600 mr-2">User:</label>
                                <select id="userSwitcher" class="border rounded p-1 text-sm"></select>
                            </div>
                            {% if is_authed %}
                            <a href="/logout" class="px-2 py-1 rounded bg-gray-100 text-gray-800"><i class="fa-solid fa-right-from-bracket"></i> Logout</a>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                <div id="globalFlashWrap" class="hidden">{% include "_flash.html" %}</div>
                {% block content %}{% endblock %}
            </div>
        </main>
    </div>
    <script>        
        (function(){
            if(window.globalToast) return;
            const hostId='toastHost';
            let toastEl=null; let hideTimer=null; let hideEndTimer=null;
            function ensure(){ let h=document.getElementById(hostId); if(!h){ h=document.createElement('div'); h.id=hostId; h.className='fixed top-4 right-4 z-50 pointer-events-none'; document.body.appendChild(h);} return h; }
            function classFor(type){ return type==='error'?['bg-red-600']:(type==='success'?['bg-green-600']:(type==='info'?['bg-blue-600']:['bg-gray-800'])); }
            window.globalToast=function(msg,type){ const host=ensure(); if(!toastEl){ toastEl=document.createElement('div'); host.appendChild(toastEl);} if(hideTimer){ clearTimeout(hideTimer); hideTimer=null; } if(hideEndTimer){ clearTimeout(hideEndTimer); hideEndTimer=null; }
                toastEl.className='pointer-events-auto inline-block px-3 py-2 rounded shadow text-sm text-white transition-opacity duration-200 '+classFor(type).join(' ');
                toastEl.style.display='';
                toastEl.style.opacity='1';
                toastEl.style.pointerEvents='auto';
                toastEl.textContent=msg; 
                hideTimer=setTimeout(()=>{                     
                    toastEl.style.opacity='0'; 
                    toastEl.style.pointerEvents='none';                    
                    hideEndTimer=setTimeout(()=>{ toastEl && (toastEl.style.display='none'); }, 240);
                }, 2600); // fade start
            };
        })();        
        (function(){
            const wrap = document.getElementById('globalFlashWrap');
            if(!wrap) return;
            const msgs = Array.from(wrap.querySelectorAll('.px-3, .flash-msg'));
            if(!msgs.length){ wrap.remove(); return; }
            const classify = (el)=>{
                const cls = el.className;
                if(/green/i.test(cls)) return 'success';
                if(/red/i.test(cls)) return 'error';
                if(/yellow|amber/i.test(cls)) return 'info';
                return 'info';
            };
            msgs.forEach((el,i)=>{
                const text = (el.textContent||'').trim();
                setTimeout(()=>{ if(window.globalToast && text) globalToast(text, classify(el)); }, i*60);
            });            
            setTimeout(()=>wrap.remove(), msgs.length*70 + 200);
        })();        
        function showUserSelectModal(users){
            const modal = document.getElementById('userSelectModal');
            const input = document.getElementById('userSelectInput');
            const confirmBtn = document.getElementById('userSelectConfirm');
            if (!modal || !input || !confirmBtn) return;
            input.innerHTML = '';
            users.forEach(u => {
                const opt = document.createElement('option');
                opt.value = u; opt.textContent = u; input.appendChild(opt);
            });
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            confirmBtn.onclick = function(){
                const selected = input.value;
                if (selected){
                    localStorage.setItem('username', selected);
                    const switcher = document.getElementById('userSwitcher');
                    if (switcher){ switcher.value = selected; }
                    renderWelcome();
                    applyUserContext();
                }
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            };
        }
        // Ensure a username is stored in localStorage; initialize after DOM is ready
        document.addEventListener('DOMContentLoaded', function(){
            const switcher = document.getElementById('userSwitcher');
            if (switcher){
                const familyEl = document.getElementById('familyData');
                let family = [];
                try { family = JSON.parse(familyEl?.textContent || '[]'); } catch(e) { family = []; }
                const adminName = '{{ config.admin_name }}';
                const users = [adminName, ...family];
                switcher.innerHTML = '';
                users.forEach(u => {
                    const opt = document.createElement('option');
                    opt.value = u; opt.textContent = u;
                    switcher.appendChild(opt);
                });
                const existing = localStorage.getItem('username');
                if (existing){
                    switcher.value = existing;
                } else {
                    // Show first-run user selection modal now that DOM is ready
                    showUserSelectModal(users);
                }
                switcher.addEventListener('change', function(){
                    localStorage.setItem('username', this.value);
                    renderWelcome();
                    applyUserContext();
                    // Notify page-level listeners to update UI without refresh
                    document.dispatchEvent(new CustomEvent('user-switched', { detail: { user: this.value }}));
                });
            }
            renderWelcome();
            applyUserContext();
            // Sidebar toggles
            const sidebar = document.getElementById('sidebar');
            const COLLAPSE_KEY = 'ui:sidebarCollapsed';
            const rootEl = document.documentElement;
            document.getElementById('openSidebar')?.addEventListener('click', ()=> sidebar.classList.remove('-translate-x-full'));
            document.getElementById('closeSidebar')?.addEventListener('click', ()=> sidebar.classList.add('-translate-x-full'));
            // Desktop collapse/expand
            const collapseIcon = document.getElementById('collapseIcon');
            function applyCollapsedState(collapsed){
                const isCollapsed = !!collapsed;
                if(window.matchMedia('(min-width: 768px)').matches){
                    sidebar.classList.toggle('collapsed', isCollapsed);
                }
                // Keep root hint in sync for next load (used to avoid flash)
                rootEl.classList.toggle('prefers-sidebar-collapsed', isCollapsed);
                if(collapseIcon){ collapseIcon.className = 'fa-solid '+(isCollapsed ? 'fa-angles-right' : 'fa-angles-left'); }
                const btn = document.getElementById('toggleCollapse');
                if(btn){ btn.title = isCollapsed ? 'Expand sidebar' : 'Collapse sidebar'; }
            }
            // Initialize from saved preference
            try{ const saved = localStorage.getItem(COLLAPSE_KEY); applyCollapsedState(saved==='1'||saved==='true'); }catch(e){}
            document.getElementById('toggleCollapse')?.addEventListener('click', ()=>{
                if(window.matchMedia('(min-width: 768px)').matches){
                    const willCollapse = !sidebar.classList.contains('collapsed');
                    applyCollapsedState(willCollapse);
                    try{ localStorage.setItem(COLLAPSE_KEY, willCollapse ? '1' : '0'); }catch(e){}
                }
            });
        });
        function renderWelcome(){
            const name = localStorage.getItem('username') || '';
            const d = new Date();
            const ds = d.toLocaleString();
            document.getElementById('welcome').textContent = name ? `Welcome, ${name}! — ${ds}` : ds;
        }
        function applyUserContext(){
            const current = localStorage.getItem('username') || '';
            const adminName = '{{ config.admin_name }}';
            // hidden inputs
            document.querySelectorAll('input[name="creator"]').forEach(function(i){ i.value = current; });
            document.querySelectorAll('input[name="user"]').forEach(function(i){ i.value = current; });
            // delete button visibility where data-creator is available
            document.querySelectorAll('.delete-form').forEach(f => {
                const creator = f.getAttribute('data-creator');
                const allowed = (current === creator || current === adminName || current === 'Administrator' || current === 'admin');
                f.style.display = allowed ? '' : 'none';
            });
            // Notice editor visibility if present
            const nf = document.getElementById('noticeForm');
            if (nf){
                const isAdmin = (current === adminName || current === 'Administrator' || current === 'admin');
                nf.style.display = isAdmin ? '' : 'none';
                const userField = nf.querySelector('input[name="user"]');
                if (userField) userField.value = current;
            }
        }
        // renderWelcome/applyUserContext are invoked from DOMContentLoaded
    </script>
    <!-- First-visit user selection modal -->
    <div id="userSelectModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
        <div class="bg-white w-full max-w-sm p-4 rounded shadow">
            <h3 class="text-lg font-semibold mb-3">Select your user</h3>
            <p class="text-sm text-gray-600 mb-3">Pick your name to personalize your HomeHub experience.</p>
            <div class="mb-3">
                <label class="block text-sm text-gray-700 mb-1" for="userSelectInput">User</label>
                <select id="userSelectInput" class="w-full border rounded p-2"></select>
            </div>
            <div class="flex justify-end gap-2">
                <button id="userSelectConfirm" class="px-3 py-2 rounded bg-blue-600 text-white">Continue</button>
            </div>
        </div>
    </div>
    
</body>
<!-- Phase 2 reminders API helper (progressive enhancement) -->
<script src="/static/js/reminders_api.js"></script>
<script>
// Register Service Worker for PWA
(function(){
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', function(){
            navigator.serviceWorker.register('/sw.js', { scope: '/' })
                .catch(function(err){ console.warn('SW registration failed', err); });
        });
    }
})();
</script>
</html>
