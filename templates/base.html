<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ config.instance_name }} - HomeHub</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: {{ config.theme.primary_color }};
            --secondary-color: {{ config.theme.secondary_color }};
            --background-color: {{ config.theme.background_color }};
            --card-background-color: {{ config.theme.card_background_color }};
            --text-color: {{ config.theme.text_color }};
            --sidebar-background-color: {{ config.theme.sidebar_background_color }};
            --sidebar-text-color: {{ config.theme.sidebar_text_color }};
            --sidebar-link-color: {{ config.theme.sidebar_link_color }};
            --sidebar-link-border-color: {{ config.theme.sidebar_link_border_color }};
        }
    </style>
    <link rel="stylesheet" href="{{ url_for('static', filename='custom.css') }}">
    <script>
        (function() {
            const mq = window.matchMedia('(prefers-color-scheme: dark)');
            const apply = () => document.documentElement.setAttribute('data-theme', mq.matches ? 'dark' : 'light');
            apply();
            try { mq.addEventListener('change', apply); } catch(e) { mq.addListener(apply); }
        })();
    </script>
</head>
<body class="min-h-screen">
    <div class="flex min-h-screen">
        <!-- Global JSON data for client scripts -->
        <script id="familyData" type="application/json">{{ config.family_members | tojson }}</script>
        <!-- Sidebar -->
        <aside id="sidebar" class="sidebar w-64 text-white flex flex-col fixed md:static inset-y-0 left-0 transform -translate-x-full md:translate-x-0 transition-transform duration-200 z-40">
            <div class="p-6 text-2xl font-bold border-b border-white/20 flex items-center justify-between" style="color: var(--sidebar-text-color);">
                <span>{{ config.instance_name }}</span>
                <button id="closeSidebar" class="md:hidden text-white/90 hover:text-white" aria-label="Close">✕</button>
            </div>
            <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
                <a href="/" class="block py-2 px-4 rounded sidebar-link">Welcome</a>
                {% if config.feature_toggles.get('notes') %}<a href="/notes" class="block py-2 px-4 rounded sidebar-link">Shared Notes</a>{% endif %}
                {% if config.feature_toggles.get('shared_cloud') %}<a href="/upload" class="block py-2 px-4 rounded sidebar-link">Shared Cloud</a>{% endif %}
                {% if config.feature_toggles.get('shopping_list') %}<a href="/shopping" class="block py-2 px-4 rounded sidebar-link">Shopping List</a>{% endif %}
                {# Removed standalone Who is Home link; dashboard section covers it #}
                {% if config.feature_toggles.get('chores') %}<a href="/chores" class="block py-2 px-4 rounded sidebar-link">To-Do/Chores</a>{% endif %}
                {% if config.feature_toggles.get('recipes') %}<a href="/recipes" class="block py-2 px-4 rounded sidebar-link">Recipe Book</a>{% endif %}
                {% if config.feature_toggles.get('expiry_tracker') %}<a href="/expiry" class="block py-2 px-4 rounded sidebar-link">Expiry Tracker</a>{% endif %}
                {% if config.feature_toggles.get('url_shortener') %}<a href="/shorten" class="block py-2 px-4 rounded sidebar-link">URL Shortener</a>{% endif %}
                {% if config.feature_toggles.get('media_downloader') %}<a href="/media" class="block py-2 px-4 rounded sidebar-link">Media Downloader</a>{% endif %}
                {% if config.feature_toggles.get('pdf_compressor') %}<a href="/pdfs" class="block py-2 px-4 rounded sidebar-link">PDF Compressor</a>{% endif %}
                {% if config.feature_toggles.get('qr_generator') %}<a href="/qr" class="block py-2 px-4 rounded sidebar-link">QR Generator</a>{% endif %}
                {% if config.feature_toggles.get('expense_tracker', true) %}<a href="/expenses" class="block py-2 px-4 rounded sidebar-link">Expense Tracker</a>{% endif %}
            </nav>
        </aside>
        <!-- Main Content -->
        <main class="main-content flex-1 p-4 md:p-8 overflow-y-auto md:ml-0 ml-0">
            <div class="max-w-none md:max-w-none mx-auto">
                <div class="sticky top-0 z-20 mb-4">
                    <div class="flex items-center flex-wrap gap-2">
                        <button id="openSidebar" class="md:hidden bg-blue-600 text-white px-3 py-2 rounded"><i class="fa-solid fa-bars"></i> Menu</button>
                        {% if not (hide_user_ui | default(false)) %}
                        <div class="ml-auto flex items-center gap-3 flex-wrap justify-end">
                            <div id="welcome" class="text-sm text-gray-600 truncate max-w-[50vw]"></div>
                            <div>
                                <label class="text-sm text-gray-600 mr-2">User:</label>
                                <select id="userSwitcher" class="border rounded p-1 text-sm"></select>
                            </div>
                            {% if is_authed %}
                            <a href="/logout" class="px-2 py-1 rounded bg-gray-100 text-gray-800"><i class="fa-solid fa-right-from-bracket"></i> Logout</a>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% include "_flash.html" %}
                {% block content %}{% endblock %}
            </div>
        </main>
    </div>
    <script>
        // First-visit user selection helper
        function showUserSelectModal(users){
            const modal = document.getElementById('userSelectModal');
            const input = document.getElementById('userSelectInput');
            const confirmBtn = document.getElementById('userSelectConfirm');
            if (!modal || !input || !confirmBtn) return;
            input.innerHTML = '';
            users.forEach(u => {
                const opt = document.createElement('option');
                opt.value = u; opt.textContent = u; input.appendChild(opt);
            });
            modal.classList.remove('hidden');
            modal.classList.add('flex');
            confirmBtn.onclick = function(){
                const selected = input.value;
                if (selected){
                    localStorage.setItem('username', selected);
                    const switcher = document.getElementById('userSwitcher');
                    if (switcher){ switcher.value = selected; }
                    renderWelcome();
                    applyUserContext();
                }
                modal.classList.add('hidden');
                modal.classList.remove('flex');
            };
        }
        // Ensure a username is stored in localStorage; initialize after DOM is ready
        document.addEventListener('DOMContentLoaded', function(){
            const switcher = document.getElementById('userSwitcher');
            if (switcher){
                const familyEl = document.getElementById('familyData');
                let family = [];
                try { family = JSON.parse(familyEl?.textContent || '[]'); } catch(e) { family = []; }
                const adminName = '{{ config.admin_name }}';
                const users = [adminName, ...family];
                switcher.innerHTML = '';
                users.forEach(u => {
                    const opt = document.createElement('option');
                    opt.value = u; opt.textContent = u;
                    switcher.appendChild(opt);
                });
                const existing = localStorage.getItem('username');
                if (existing){
                    switcher.value = existing;
                } else {
                    // Show first-run user selection modal now that DOM is ready
                    showUserSelectModal(users);
                }
                switcher.addEventListener('change', function(){
                    localStorage.setItem('username', this.value);
                    renderWelcome();
                    applyUserContext();
                    // Notify page-level listeners to update UI without refresh
                    document.dispatchEvent(new CustomEvent('user-switched', { detail: { user: this.value }}));
                });
            }
            renderWelcome();
            applyUserContext();
            // Sidebar toggles
            const sidebar = document.getElementById('sidebar');
            document.getElementById('openSidebar')?.addEventListener('click', ()=> sidebar.classList.remove('-translate-x-full'));
            document.getElementById('closeSidebar')?.addEventListener('click', ()=> sidebar.classList.add('-translate-x-full'));
        });
        function renderWelcome(){
            const name = localStorage.getItem('username') || '';
            const d = new Date();
            const ds = d.toLocaleString();
            document.getElementById('welcome').textContent = name ? `Welcome, ${name}! — ${ds}` : ds;
        }
        function applyUserContext(){
            const current = localStorage.getItem('username') || '';
            const adminName = '{{ config.admin_name }}';
            // hidden inputs
            document.querySelectorAll('input[name="creator"]').forEach(function(i){ i.value = current; });
            document.querySelectorAll('input[name="user"]').forEach(function(i){ i.value = current; });
            // delete button visibility where data-creator is available
            document.querySelectorAll('.delete-form').forEach(f => {
                const creator = f.getAttribute('data-creator');
                const allowed = (current === creator || current === adminName || current === 'Administrator' || current === 'admin');
                f.style.display = allowed ? '' : 'none';
            });
            // Notice editor visibility if present
            const nf = document.getElementById('noticeForm');
            if (nf){
                const isAdmin = (current === adminName || current === 'Administrator' || current === 'admin');
                nf.style.display = isAdmin ? '' : 'none';
                const userField = nf.querySelector('input[name="user"]');
                if (userField) userField.value = current;
            }
        }
        // renderWelcome/applyUserContext are invoked from DOMContentLoaded
    </script>
    <!-- First-visit user selection modal -->
    <div id="userSelectModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
        <div class="bg-white w-full max-w-sm p-4 rounded shadow">
            <h3 class="text-lg font-semibold mb-3">Select your user</h3>
            <p class="text-sm text-gray-600 mb-3">Pick your name to personalize your HomeHub experience.</p>
            <div class="mb-3">
                <label class="block text-sm text-gray-700 mb-1" for="userSelectInput">User</label>
                <select id="userSelectInput" class="w-full border rounded p-2"></select>
            </div>
            <div class="flex justify-end gap-2">
                <button id="userSelectConfirm" class="px-3 py-2 rounded bg-blue-600 text-white">Continue</button>
            </div>
        </div>
    </div>
    
</body>
</html>
