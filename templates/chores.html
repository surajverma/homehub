{% extends "base.html" %}
{% block content %}
<div class="mx-auto">
    <h2 class="text-xl font-bold mb-4">To-Do / Chores</h2>
    <form method="POST" id="choreForm" class="mb-2">
        <div class="grid grid-cols-1 md:grid-cols-12 gap-3">
            <div class="md:col-span-5">
                <label class="block text-sm text-gray-600 dark:text-gray-300 mb-1">Chore</label>
                <div class="relative h-11">
                    <input type="text" name="description" id="choreInput" class="w-full h-full p-2 border border-gray-300 dark:border-gray-600 rounded focus:outline-none focus:ring-1 focus:ring-blue-500" placeholder="Add a chore..." required autocomplete="off">
                    <div id="choreSuggestions" class="absolute left-0 right-0 z-10 mt-1 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded shadow hidden max-h-72 overflow-auto"></div>
                </div>
            </div>
            <div class="md:col-span-4">
                <label class="block text-sm text-gray-600 dark:text-gray-300 mb-1">Tags (assignees, context)</label>
                <div class="flex flex-wrap gap-2 rounded  focus-within:ring-1 focus-within:ring-blue-500 items-start h-11" id="tagInputWrap">
                    <input type="text" id="tagInput" class="flex-1 min-w-[140px] h-full p-2 border border-gray-300 dark:border-gray-600 rounded focus:outline-none focus:ring-1 focus:ring-blue-500" placeholder="Add tag and press Enter">
                </div>
                <input type="hidden" name="tags" id="tagsField" value="[]">
                <div class="mt-2 flex flex-wrap gap-2 text-xs" id="tagLibrary"></div>
            </div>
            <div class="md:col-span-3">
                <label class="block text-sm text-gray-600 dark:text-gray-300 mb-1 opacity-0">Action</label>
                <input type="hidden" name="creator" id="creator">
                <button type="submit" class="w-full btn btn-primary h-11">Add</button>
            </div>
        </div>
    </form>

    <div class="mb-4 flex flex-wrap gap-2 items-center">
        <span class="text-sm text-gray-600">Filter by tag:</span>
        <div id="tagFilters" class="flex flex-wrap gap-2"></div>
        <button id="clearTagFilters" class="btn btn-secondary text-xs">Clear</button>
    </div>

    <ul id="choreList" class="space-y-2">
        {% for chore in chores %}
        {% set tags = (chore.tags or '[]') %}
        <li class="card p-4 flex flex-col gap-2" data-id="{{ chore.id }}" data-tags='{{ tags|safe }}' data-done="{{ '1' if chore.done else '0' }}">
            <div class="flex flex-wrap gap-2 items-center">
                <span class="flex-1 {% if chore.done %}line-through text-gray-400{% endif %}">{{ chore.description }}</span>
                <div class="hidden md:flex flex-wrap gap-2 item-tags" data-id="{{ chore.id }}"></div>
                <form method="POST" action="/chores/toggle/{{ chore.id }}">
                    <button type="submit" class="btn {{ 'btn-secondary' if chore.done else 'btn-success' }}">
                        {{ 'Completed Â· Undo' if chore.done else 'Mark Completed' }}
                    </button>
                </form>
                <button type="button" class="btn btn-secondary edit-btn" data-id="{{ chore.id }}">Edit</button>
                <form method="POST" action="/chores/delete/{{ chore.id }}" class="delete-form" data-creator="{{ chore.creator }}">
                    <input type="hidden" name="user">
                    <button type="submit" class="btn btn-danger" title="Delete"><i class="fa fa-times"></i></button>
                </form>
            </div>
            <div class="flex flex-wrap gap-2 items-center justify-between text-xs text-gray-500">
                <div>By {{ chore.creator }} at {{ chore.timestamp.strftime('%Y-%m-%d %H:%M') }}</div>
                <div class="flex-1"></div>
            </div>
            <div class="md:hidden flex flex-wrap gap-2 items-center item-tags" data-id="{{ chore.id }}"></div>
        </li>
        {% endfor %}
    </ul>
</div>

<script src="{{ url_for('static', filename='js/tags.js') }}"></script>
<script src="{{ url_for('static', filename='js/form_tags.js') }}"></script>
<script>
// Initialize creator
document.getElementById('creator').value = localStorage.getItem('username') || '';
document.querySelectorAll('input[name="user"]').forEach(i=> i.value = localStorage.getItem('username') || '');

// Scoped Tags for chores
const T = Tags.scoped('chores');

// Tag input handling for create form (reusable)
(function(){
    FormTags.initTagInputForm(T, {
        formId: 'choreForm',
        wrapId: 'tagInputWrap',
        inputId: 'tagInput',
        hiddenId: 'tagsField',
        libraryId: 'tagLibrary'
    });
})();

// Build filter chips from all known tags
(function(){
    const filterHost = document.getElementById('tagFilters');
    const clearBtn = document.getElementById('clearTagFilters');
    const selected = new Set();
    function collectTags(){
        const set = new Set();
        document.querySelectorAll('#choreList li').forEach(li=>{
            try{ (JSON.parse(li.dataset.tags||'[]')||[]).forEach(t=> set.add(t)); }catch(e){}
        });
        T.getAllKnownTags().forEach(t=> set.add(t));
        return [...set].sort((a,b)=> a.localeCompare(b));
    }
    function apply(){
        const tags = [...selected];
        document.querySelectorAll('#choreList li').forEach(li=>{
            if(!tags.length){ li.classList.remove('hidden'); return; }
            let matched=false; try{ const tg=JSON.parse(li.dataset.tags||'[]')||[]; matched = tg.some(t=>tags.includes(t)); }catch(e){}
            li.classList.toggle('hidden', !matched);
        });
    }
    function render(){
        const all = collectTags();
        filterHost.innerHTML='';
        all.forEach(t=>{
            const pill = T.makePill(t, ()=>{ if(selected.has(t)) selected.delete(t); else selected.add(t); render(); apply(); }, selected.has(t));
            filterHost.appendChild(pill);
        });
    }
    clearBtn.addEventListener('click', ()=>{ selected.clear(); render(); apply(); });
    T.onChange(()=> render());
    render();
})();

// Per-item tags UI and update via API
(function(){
    const list = document.getElementById('choreList');
    function renderItemTags(li){
        const id = li.dataset.id;
        let tags=[]; try{ tags = JSON.parse(li.dataset.tags||'[]')||[]; }catch(e){}
        const hosts = li.querySelectorAll('.item-tags');
        hosts.forEach(host=>{ host.innerHTML = ''; });
        hosts.forEach(host=>{ tags.forEach(t=> host.appendChild(T.makeFilledPill(t))); });
        T.recordTags(tags);
    }
    list.querySelectorAll('li').forEach(li=>{
        renderItemTags(li);
    });
})();

// Hide delete for non-owners (fallback)
(function(){
    const adminName='{{ config.admin_name }}';
    const current=localStorage.getItem('username');
    document.querySelectorAll('.delete-form').forEach(f=>{
        const c=f.getAttribute('data-creator');
        if(!(current===c||current===adminName||current==='Administrator'||current==='admin')) f.style.display='none';
    });
})();

// Edit modal for chore + tags
(function(){
        const modal = document.createElement('div');
        modal.id = 'editModal';
        modal.className = 'fixed inset-0 hidden items-center justify-center bg-black/50 z-50';
        modal.innerHTML = `
            <div class="bg-white dark:bg-gray-800 rounded shadow max-w-lg w-full p-4">
                <h3 class="text-lg font-semibold mb-3">Edit Chore</h3>
                <div class="mb-3">
                    <label class="block text-sm mb-1">Chore</label>
                    <input type="text" id="editDescInput" class="w-full p-2 border border-gray-300 dark:border-gray-600 rounded focus:outline-none focus:ring-1 focus:ring-blue-500" />
                </div>
                <div>
                    <label class="block text-sm mb-1">Tags</label>
                    <div id="editTagWrap" class="flex flex-wrap gap-2 border border-gray-300 dark:border-gray-600 rounded p-2 focus-within:ring-1 focus-within:ring-blue-500">
                        <input type="text" id="editTagInput" class="flex-1 min-w-[140px] outline-none bg-transparent" placeholder="Add tag and press Enter" />
                    </div>
                            <div class="mt-2 flex flex-wrap gap-2 text-xs" id="editTagLibrary"></div>
                </div>
                <div class="mt-4 flex justify-end gap-2">
                    <button type="button" id="editCancel" class="btn btn-secondary">Cancel</button>
                    <button type="button" id="editSave" class="btn btn-primary">Save</button>
                </div>
            </div>`;
        document.body.appendChild(modal);
        const editBtns = document.querySelectorAll('.edit-btn');
        let currentId = null; let tags = [];
        const descInput = document.getElementById('editDescInput');
        const tagWrap = document.getElementById('editTagWrap');
        const tagInput = document.getElementById('editTagInput');
        function render(){ T.renderPills(tagWrap, tags, (t)=>{ tags = tags.filter(x=>x!==t); render(); }); }
        tagInput.addEventListener('keydown', (e)=>{
            if(e.key==='Enter' || e.key===','){ e.preventDefault(); const v=tagInput.value.trim(); if(v && !tags.includes(v)){ tags.push(v); T.ensureColor(v); render(); } tagInput.value=''; }
            if(e.key==='Backspace' && !tagInput.value && tags.length){ tags.pop(); render(); }
        });
            function open(id){
            currentId = id;
            const li = document.querySelector(`#choreList li[data-id="${id}"]`);
            if(!li) return;
            let tg=[]; try{ tg = JSON.parse(li.dataset.tags||'[]')||[]; }catch(e){}
            tags = tg.slice(); render();
            descInput.value = li.querySelector('span.flex-1').textContent.trim();
                const lib = document.getElementById('editTagLibrary');
                T.renderLibrary(lib, (t)=>{ if(!tags.includes(t)){ tags.push(t); render(); }});
            modal.classList.remove('hidden'); modal.classList.add('flex');
            descInput.focus();
        }
        async function save(){
            if(!currentId) return;
            FormTags.harvestPendingInto(T, tagInput, tags);
            const payload = { description: descInput.value.trim(), tags: tags };
            try{
                const res = await fetch(`/api/chores/${currentId}`, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
                const data = await res.json();
                if(data.ok){
                    const li = document.querySelector(`#choreList li[data-id="${currentId}"]`);
                    if(li){
                        li.dataset.tags = JSON.stringify(data.item.tags||[]);
                        li.querySelector('span.flex-1').textContent = data.item.description;
                        const hosts = li.querySelectorAll('.item-tags');
                        hosts.forEach(host=>{ host.innerHTML=''; (data.item.tags||[]).forEach(t=> host.appendChild(T.makePill(t))); });
                                    T.recordTags(data.item.tags||[]);
                                    refreshFiltersAndLibrary();
                    }
                    close();
                }
            }catch(e){ console.error(e); }
        }
        function close(){ modal.classList.add('hidden'); modal.classList.remove('flex'); currentId=null; }
        document.getElementById('editCancel').addEventListener('click', close);
        document.getElementById('editSave').addEventListener('click', save);
        editBtns.forEach(btn=> btn.addEventListener('click', ()=> open(btn.dataset.id)));
})();

function refreshFiltersAndLibrary(){
    const filterHost = document.getElementById('tagFilters');
    const allTags = new Set();
    document.querySelectorAll('#choreList li').forEach(li=>{
        try{ (JSON.parse(li.dataset.tags||'[]')||[]).forEach(t=>allTags.add(t)); }catch(e){}
    });
    T.getAllKnownTags().forEach(t=> allTags.add(t));
    filterHost.innerHTML='';
    [...allTags].sort((a,b)=>a.localeCompare(b)).forEach(t=>{
          const pill = T.makeFilledPill(t, null, false);
            filterHost.appendChild(pill);
    });
    const lib = document.getElementById('tagLibrary');
    T.renderLibrary(lib, (t)=>{
        const hidden = document.getElementById('tagsField');
        let tags=[]; try{ tags = JSON.parse(hidden.value||'[]'); }catch(e){}
        if(!tags.includes(t)){
            tags.push(t); hidden.value = JSON.stringify(tags);
            const wrap = document.getElementById('tagInputWrap');
            T.renderPills(wrap, tags, (rm)=>{ tags = tags.filter(x=>x!==rm); hidden.value=JSON.stringify(tags); T.renderPills(wrap, tags, ()=>{}); });
        }
    });
}

T.onChange(()=> refreshFiltersAndLibrary());
</script>
<script>
// Chore suggestions (mirror shopping): use persisted history + hide list
(function(){
    const box = document.getElementById('choreSuggestions');
    const input = document.getElementById('choreInput');
    const HIDE_KEY = 'chores:hidden_suggestions';
    const BASE_KEY = 'chores:history_suggestions';
    function getHidden(){ try{return new Set(JSON.parse(localStorage.getItem(HIDE_KEY)||'[]'));}catch(e){return new Set();} }
    function setHidden(s){ try{ localStorage.setItem(HIDE_KEY, JSON.stringify([...s])); }catch(e){} }
    function getBase(){ try{return JSON.parse(localStorage.getItem(BASE_KEY)||'[]')||[];}catch(e){return [];} }
    function setBase(arr){ try{ localStorage.setItem(BASE_KEY, JSON.stringify(arr||[])); }catch(e){} }
    // Seed base with current chores once (if empty)
    (function seed(){ const base=getBase(); if(!base.length){ const seeds=[...document.querySelectorAll('#choreList li span.flex-1')].map(n=> n.textContent.trim()).filter(Boolean); if(seeds.length) setBase([...new Set(seeds)]);} })();
    function render(){
        const q = (input?.value||'').trim().toLowerCase();
        const hidden = getHidden();
        const base = getBase();
        const existing = new Set([...document.querySelectorAll('#choreList li span.flex-1')]
            .map(n=> n.textContent.trim().toLowerCase()));
        const list = base
            .filter(s=> !hidden.has(s)
                        && !existing.has(s.toLowerCase())
                        && (!q || s.toLowerCase().includes(q)))
            .slice(0,50);
        if(!list.length){ box.classList.add('hidden'); box.innerHTML=''; return; }
        box.innerHTML='';
        list.forEach(s=>{
            const row = document.createElement('div');
            row.className = 'flex items-center justify-between px-3 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer select-none';
            const text = document.createElement('div'); text.textContent = s; text.className='truncate pr-2 flex-1';
            const del = document.createElement('button'); del.type='button'; del.title='Hide'; del.className='text-red-600'; del.innerHTML='<i class="fa fa-times"></i>';
            del.addEventListener('click', (e)=>{ e.stopPropagation(); const h=getHidden(); h.add(s); setHidden(h); render(); });
            row.appendChild(text); const actions=document.createElement('div'); actions.className='flex items-center gap-2'; actions.appendChild(del); row.appendChild(actions);
            row.addEventListener('click', ()=>{ input.value = s; box.classList.add('hidden'); input.focus(); });
            box.appendChild(row);
        });
        box.classList.remove('hidden');
    }
    if(input){ input.addEventListener('input', render); input.addEventListener('focus', render); }
    document.addEventListener('click', (e)=>{ if(!box.contains(e.target) && e.target!==input){ box.classList.add('hidden'); }});
    // After successful form submit, add chore text to history base
    const form = document.getElementById('choreForm');
    form?.addEventListener('submit', ()=>{
        const val = (input?.value||'').trim();
        if(val){ const base = new Set(getBase()); base.add(val); setBase([...base]); }
    });
})();
</script>
{% endblock %}
